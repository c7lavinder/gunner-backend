<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ”« Gunner â€” Command Center</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0e1a;--sidebar:#0f1322;--card:#111827;--border:#1f2937;--blue:#3b82f6;--cyan:#06b6d4;--green:#22c55e;--yellow:#eab308;--orange:#f97316;--red:#ef4444;--purple:#a855f7;--pink:#ec4899;--text:#f1f5f9;--muted:#94a3b8;--dim:#64748b}
html,body{height:100%;overflow:hidden}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);line-height:1.5}
a{color:var(--cyan);text-decoration:none}
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

/* â”€â”€ TOP BAR â”€â”€ */
.topbar{height:56px;background:var(--sidebar);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 20px;gap:16px;position:fixed;top:0;left:0;right:0;z-index:100}
.topbar-logo{font-size:1.2rem;font-weight:800;display:flex;align-items:center;gap:8px;white-space:nowrap}
.topbar-logo span{background:linear-gradient(135deg,#fff,var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.preview-badge{background:var(--orange);color:#000;font-size:.7rem;font-weight:800;padding:4px 12px;border-radius:6px;display:flex;align-items:center;gap:4px;white-space:nowrap}
.api-badge{font-size:.75rem;font-weight:600;display:flex;align-items:center;gap:4px;white-space:nowrap}
.api-dot{width:7px;height:7px;border-radius:50%;display:inline-block}
.topbar-stats{display:flex;gap:16px;margin-left:auto;font-size:.78rem;color:var(--muted);align-items:center;flex-wrap:nowrap;overflow-x:auto}
.topbar-stats .ts{display:flex;align-items:center;gap:4px;white-space:nowrap}
.topbar-stats .ts .dot{width:6px;height:6px;border-radius:50%;display:inline-block}
.topbar-nav{display:flex;gap:12px;margin-left:16px;font-size:.82rem}
.topbar-nav a{color:var(--dim);font-weight:600;padding:4px 8px;border-radius:6px;transition:all .15s}
.topbar-nav a:hover,.topbar-nav a.active{color:var(--text);background:rgba(255,255,255,.05)}

/* â”€â”€ TABS â”€â”€ */
.tab-bar{height:44px;background:var(--sidebar);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 20px;gap:4px;position:fixed;top:56px;left:0;right:0;z-index:99}
.tab{padding:8px 18px;font-size:.85rem;font-weight:600;color:var(--dim);cursor:pointer;border-radius:8px 8px 0 0;border:1px solid transparent;border-bottom:none;transition:all .15s;position:relative}
.tab:hover{color:var(--muted);background:rgba(255,255,255,.03)}
.tab.active{color:var(--text);background:var(--bg);border-color:var(--border)}
.tab-desc{margin-left:16px;font-size:.82rem;color:var(--dim)}

/* â”€â”€ MAIN LAYOUT â”€â”€ */
.main{display:flex;position:fixed;top:100px;left:0;right:0;bottom:0}

/* â”€â”€ SIDEBAR â”€â”€ */
.sidebar{width:300px;min-width:300px;background:var(--sidebar);border-right:1px solid var(--border);overflow-y:auto;padding:8px 0}
.sidebar-group{padding:8px 0}
.sidebar-group-label{font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--dim);padding:12px 16px 6px;display:flex;align-items:center;gap:6px}
.agent-row{display:flex;align-items:center;padding:10px 16px;cursor:pointer;transition:background .12s;gap:10px;border-left:3px solid transparent}
.agent-row:hover{background:rgba(255,255,255,.03)}
.agent-row.selected{background:rgba(6,182,212,.06);border-left-color:var(--cyan)}
.agent-row .ar-emoji{font-size:1rem;flex-shrink:0;width:22px;text-align:center}
.agent-row .ar-info{flex:1;min-width:0}
.agent-row .ar-name{font-size:.85rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.agent-row .ar-status{font-size:.72rem;color:var(--dim);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.agent-row .ar-toggle{color:var(--dim);font-size:1rem;flex-shrink:0;cursor:pointer;width:20px;text-align:center}
.agent-row .ar-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.dot-idle{background:var(--blue);opacity:.5}
.dot-active{background:var(--green);box-shadow:0 0 6px rgba(34,197,94,.5)}
.dot-error{background:var(--red);box-shadow:0 0 6px rgba(239,68,68,.5)}

/* â”€â”€ DETAIL PANEL â”€â”€ */
.detail{flex:1;overflow-y:auto;padding:32px 40px 60px}
.detail-empty{display:flex;align-items:center;justify-content:center;height:100%;color:var(--dim);font-size:1rem}

.detail-section{margin-bottom:28px}
.detail-section-title{font-size:.78rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;display:flex;align-items:center;gap:6px}
.dst-cyan{color:var(--cyan)}
.dst-green{color:var(--green)}
.dst-red{color:var(--red)}
.dst-yellow{color:var(--yellow)}
.dst-purple{color:var(--purple)}

.trigger-pills{display:flex;gap:8px;flex-wrap:wrap}
.pill{padding:8px 14px;border-radius:8px;font-size:.78rem;font-weight:600;background:rgba(34,197,94,.12);color:var(--green);border:1px solid rgba(34,197,94,.25);display:flex;flex-direction:column;gap:2px;min-width:140px}
.pill-cyan{background:rgba(6,182,212,.12);color:var(--cyan);border-color:rgba(6,182,212,.25)}
.pill-purple{background:rgba(168,85,247,.12);color:var(--purple);border-color:rgba(168,85,247,.25)}
.pill-orange{background:rgba(249,115,22,.12);color:var(--orange);border-color:rgba(249,115,22,.25)}
.pill-pink{background:rgba(236,72,153,.12);color:var(--pink);border-color:rgba(236,72,153,.25)}
.pill .pill-event{font-size:.65rem;text-transform:uppercase;letter-spacing:.5px;opacity:.7}
.pill .pill-stage{font-size:.82rem;font-weight:700}

.detail-text{font-size:.95rem;color:var(--muted);line-height:1.7}
.detail-bullets{list-style:none;padding:0}
.detail-bullets li{font-size:.95rem;color:var(--muted);padding:6px 0;display:flex;align-items:flex-start;gap:8px;line-height:1.6}
.detail-bullets li::before{content:'â€º';color:var(--green);font-weight:700;font-size:1.1rem;flex-shrink:0;margin-top:-1px}

.output-list{list-style:none;padding:0}
.output-item{display:flex;align-items:flex-start;gap:10px;padding:8px 12px;margin-bottom:6px;background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:8px}
.output-type{font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;padding:3px 8px;border-radius:4px;white-space:nowrap;flex-shrink:0;margin-top:1px}
.ot-sms{background:rgba(34,197,94,.15);color:var(--green)}
.ot-task{background:rgba(234,179,8,.15);color:var(--yellow)}
.ot-note{background:rgba(6,182,212,.15);color:var(--cyan)}
.ot-tag{background:rgba(168,85,247,.15);color:var(--purple)}
.ot-stage{background:rgba(249,115,22,.15);color:var(--orange)}
.ot-email{background:rgba(236,72,153,.15);color:var(--pink)}
.ot-api{background:rgba(59,130,246,.15);color:var(--blue)}
.ot-data{background:rgba(255,255,255,.1);color:var(--muted)}
.ot-alert{background:rgba(239,68,68,.15);color:var(--red)}
.output-text{font-size:.88rem;color:var(--text);line-height:1.5}

.issues-list{list-style:none;padding:0}
.issues-list li{font-size:.88rem;color:var(--red);padding:4px 0;opacity:.9}
.issues-list li::before{content:'Â· '}

.learning-text{font-size:.95rem;color:var(--muted);line-height:1.7}

/* Stats row at bottom of detail */
.detail-stats{display:flex;gap:0;margin-top:8px;border:1px solid var(--border);border-radius:12px;overflow:hidden}
.ds-item{flex:1;padding:18px 20px;text-align:center;border-right:1px solid var(--border)}
.ds-item:last-child{border-right:none}
.ds-val{font-size:1.6rem;font-weight:800}
.ds-val.val-green{color:var(--green)}
.ds-val.val-cyan{color:var(--cyan)}
.ds-val.val-red{color:var(--red)}
.ds-label{font-size:.72rem;color:var(--dim);margin-top:2px}

/* â”€â”€ LIVE FEED TAB â”€â”€ */
.feed-panel{display:none;flex:1;overflow-y:auto;padding:20px}
.feed-entry{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:8px}
.feed-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.feed-agent{font-weight:700;font-size:.85rem;display:flex;align-items:center;gap:6px}
.feed-time{color:var(--dim);font-size:.75rem}
.feed-action{font-size:.88rem;color:var(--muted);margin-bottom:6px}
.feed-badges{display:flex;gap:6px;flex-wrap:wrap;font-size:.72rem}
.fb-success{color:var(--green)}
.fb-error{color:var(--red)}
.fb-contact{color:var(--cyan)}

/* â”€â”€ TRIGGERS TAB â”€â”€ */
.triggers-panel{display:none;flex:1;overflow-y:auto;padding:32px 40px}
.trig-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:12px;display:flex;align-items:center;gap:16px;flex-wrap:wrap}
.trig-event-box{min-width:180px;text-align:center}
.trig-event-icon{font-size:1.3rem}
.trig-event-label{font-size:.85rem;font-weight:700}
.trig-event-sub{font-size:.72rem;color:var(--dim)}
.trig-arrow{color:var(--dim);font-size:1.2rem}
.trig-agents-list{display:flex;gap:6px;flex-wrap:wrap}
.trig-agent-pill{background:rgba(59,130,246,.1);border:1px solid rgba(59,130,246,.2);border-radius:8px;padding:5px 10px;font-size:.72rem;font-weight:600;color:var(--cyan);white-space:nowrap}
.trig-output-box{background:rgba(34,197,94,.06);border:1px solid rgba(34,197,94,.15);border-radius:8px;padding:10px 14px;font-size:.82rem;color:var(--green);max-width:400px}
.trig-output-box strong{display:block;font-size:.68rem;color:var(--dim);margin-bottom:2px;text-transform:uppercase;letter-spacing:.5px}

@media(max-width:768px){
.sidebar{width:220px;min-width:220px}
.detail{padding:20px}
.topbar-stats{display:none}
}
</style>
</head>
<body>

<!-- â•â•â• TOP BAR â•â•â• -->
<div class="topbar">
  <div class="topbar-logo">ğŸ”« <span>Gunner â€” Command Center</span></div>
  <div class="preview-badge">âœï¸ PREVIEW MODE</div>
  <div class="api-badge"><span class="api-dot" style="background:var(--red)"></span> API Key</div>
  <div class="topbar-stats">
    <span class="ts"><span class="dot" style="background:var(--red)"></span> <span id="tsOverdue">0</span> Overdue</span>
    <span class="ts"><span class="dot" style="background:var(--yellow)"></span> <span id="tsAtRisk">0</span> At Risk</span>
    <span class="ts">â€” checked</span>
    <span class="ts"><strong id="tsDrip">0</strong> in drip</span>
    <span class="ts"><strong id="tsLeads">0</strong> leads today</span>
    <span class="ts">GHL: <span class="dot" style="background:var(--purple)"></span> Polling</span>
    <span class="ts">API: <span class="dot" style="background:var(--green)"></span> Clean</span>
    <span class="ts">Acct. last run: â€”</span>
  </div>
  <div class="topbar-nav">
    <a href="/dashboard">â† Dashboard</a>
    <a href="/dashboard/controls">Controls</a>
    <a href="/dashboard/audit" class="active">Audit</a>
  </div>
</div>

<!-- â•â•â• TABS â•â•â• -->
<div class="tab-bar">
  <div class="tab" data-tab="leads" onclick="switchTab('leads')">ğŸ‘¤ Leads</div>
  <div class="tab active" data-tab="agents" onclick="switchTab('agents')">ğŸ¤– Agents</div>
  <div class="tab" data-tab="triggers" onclick="switchTab('triggers')">âš¡ Triggers</div>
  <span class="tab-desc" id="tabDesc">What each AI agent is doing</span>
</div>

<!-- â•â•â• MAIN â•â•â• -->
<div class="main">
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar"></div>
  
  <!-- Agent Detail Panel -->
  <div class="detail" id="detailPanel">
    <div class="detail-empty">â† Select an agent to view details</div>
  </div>

  <!-- Triggers Panel -->
  <div class="triggers-panel" id="triggersPanel"></div>

  <!-- Leads/Feed Panel -->
  <div class="feed-panel" id="feedPanel">
    <div style="color:var(--dim);text-align:center;padding:60px">Live feed â€” waiting for activity...</div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AGENT DIRECTORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const GROUPS = [
  { label: 'ğŸ†• NEW LEAD PIPELINE', agents: ['data-hygiene','lead-iq','initial-outreach','working-drip'] },
  { label: 'ğŸ“ LM CALLS', agents: ['lm-assistant','call-coaching','response-agent'] },
  { label: 'ğŸ¤ AM CALLS & OFFERS', agents: ['am-assistant','apt-prep','offer-chase','offer-reply'] },
  { label: 'ğŸ‘» FOLLOW-UP', agents: ['follow-up-organizer','follow-up-messenger','follow-up-closer','ghosted-agent','bucket-reeval','already-sold-agent'] },
  { label: 'ğŸ“ UNDER CONTRACT', agents: ['contract-bot','uc-monitor','tc-packager','dispo-packager','post-close-bot'] },
  { label: 'ğŸ“¦ DISPO', agents: ['deal-intake','buyer-matcher','deal-blaster','offer-collector','jv-router','deal-terminator','dispo-closer','title-coordinator','dispo-closing-agent'] },
  { label: 'ğŸ›¡ï¸ SYSTEM', agents: ['accountability','reality-check','callback-capture','stage-change-router','morning-briefing'] },
];

const AGENTS = {
  'data-hygiene': {
    emoji:'ğŸ§¹', name:'Data Hygiene',
    whenFires:'Fires automatically the moment a new lead enters your pipeline.',
    triggers:[{event:'Webhook',label:'OpportunityCreate',color:'green'},{event:'Stage Change',label:'â†’ New Lead',color:'cyan'}],
    whatItDoes:['Verifies the phone number, email, and address are real','Enriches lead with BatchLeads: AVM, equity, distress flags, driving distance','Grades property condition from Street View (Aâ€“F scale)','Flags anything that looks wrong so your team doesn\'t waste a call'],
    outputs:[
      {type:'data',label:'DATA',text:'Updates contact: AVM, equity %, distress flags, driving distance from BatchLeads'},
      {type:'note',label:'NOTE',text:'Adds CRM note: "Data Hygiene: Phone âœ… | Email âœ… | Address âœ… | AVM: $XXX,XXX | Equity: XX%"'},
      {type:'tag',label:'TAG',text:'Tags contact: "Bad Phone" or "Bad Email" if verification fails'},
      {type:'data',label:'DATA',text:'Sets property condition grade (Aâ€“F) from Street View analysis'},
      {type:'alert',label:'ALERT',text:'Flags lead for manual review if 2+ data points fail verification'},
    ],
    issues:['BatchLeads enrichment skips if BATCHLEADS_API_KEY not set','Property condition grading skips if Google Maps key not set'],
    learning:'Every time a contact record gets corrected after cleaning, Gunner notes the pattern. Over time it gets better at recognizing bad sources â€” so fewer bad records make it through.'
  },
  'lead-iq': {
    emoji:'ğŸ§ ', name:'Lead IQ',
    whenFires:'Fires on every new lead to build an intelligence profile.',
    triggers:[{event:'Webhook',label:'OpportunityCreate',color:'green'}],
    whatItDoes:['Analyzes seller motivation from lead source data','Scores urgency, timeline, and property condition','Creates initial intelligence profile for the contact','Flags high-priority leads for immediate action'],
    outputs:[
      {type:'note',label:'NOTE',text:'Adds CRM note: "Lead IQ: Score XX/100 | Motivation: HIGH | Timeline: 30 days | Condition: Fair"'},
      {type:'data',label:'DATA',text:'Sets lead_score, motivation_level, timeline_urgency on contact record'},
      {type:'tag',label:'TAG',text:'Tags contact: "Hot Lead", "Motivated Seller", or "Low Priority"'},
      {type:'alert',label:'ALERT',text:'If score â‰¥ 75: flags as HOT â€” team gets priority notification'},
    ],
    issues:null,
    learning:'Tracks which lead sources produce the most motivated sellers and adjusts scoring weights over time.'
  },
  'initial-outreach': {
    emoji:'ğŸ“±', name:'Initial Outreach',
    whenFires:'Fires on every new lead â€” sends the first text within 3 minutes.',
    triggers:[{event:'Webhook',label:'OpportunityCreate',color:'green'},{event:'Pipeline',label:'Sales â†’ New Lead',color:'cyan'}],
    whatItDoes:['Sends personalized first text within 3 minutes','Matches tone to lead source and motivation level','Respects 9AMâ€“6PM send window (TCPA compliance)','Queues for next morning if outside window'],
    outputs:[
      {type:'sms',label:'SMS',text:'Sends: "Hi [name], this is [LM] with New Again Houses. Someone nearby [address] inquired about the home. Available for a sec? Reply STOP to opt out"'},
      {type:'note',label:'NOTE',text:'Adds CRM note: "Initial outreach sent at [time] â€” [template variant used]"'},
      {type:'task',label:'TASK',text:'If outside send window: creates scheduled task "Send initial text at 9:00 AM"'},
    ],
    issues:null,
    learning:'Tracks which opening messages get responses and refines templates over time.'
  },
  'working-drip': {
    emoji:'ğŸ’§', name:'Working Drip',
    whenFires:'Fires when a lead moves to Warm or Hot stage.',
    triggers:[{event:'Stage Change',label:'â†’ Warm Lead',color:'cyan'},{event:'Stage Change',label:'â†’ Hot Lead',color:'orange'}],
    whatItDoes:['Activates 24-touch drip sequence over 104 days','Personalizes each message based on property and seller','Pauses automatically if seller responds','Cancels permanently on appointment set'],
    outputs:[
      {type:'sms',label:'SMS',text:'Sends drip touch: "Hey [name], just checking in on [address]. Still thinking about selling? â€” [LM]"'},
      {type:'data',label:'DATA',text:'Sets drip_active=true, drip_touch=X, drip_next_date on contact'},
      {type:'note',label:'NOTE',text:'Adds CRM note: "Drip touch #X/24 sent â€” Day [N] of sequence"'},
      {type:'stage',label:'STAGE',text:'On seller response: pauses drip, routes to Response Agent'},
      {type:'stage',label:'STAGE',text:'On appointment set: cancels drip permanently, clears drip fields'},
    ],
    issues:null,
    learning:'Monitors which drip touches get responses and optimizes timing and messaging.'
  },
  'lm-assistant': {
    emoji:'ğŸ“', name:'LM Assistant',
    whenFires:'Fires after every completed call between LM and a lead.',
    triggers:[{event:'Gunner Webhook',label:'Call Completed',color:'purple'},{event:'Source',label:'Gunner Call Recording',color:'cyan'}],
    whatItDoes:['Summarizes call and posts CRM note','Identifies next steps from conversation','Creates follow-up tasks automatically','Flags coaching opportunities for the call'],
    outputs:[
      {type:'note',label:'NOTE',text:'Adds CRM note: "Call Summary: [2-3 sentence AI summary of conversation, key points, seller sentiment]"'},
      {type:'task',label:'TASK',text:'Creates task for LM: "[Next step from call] â€” due [timeframe]"'},
      {type:'tag',label:'TAG',text:'Tags call outcome: "Appointment Set", "Not Right Now", "Wrong Number", "No Answer"'},
      {type:'data',label:'DATA',text:'Updates contact: last_call_date, call_disposition, call_count'},
    ],
    issues:null,
    learning:'Improves call summaries based on coaching feedback and which summaries LMs find most useful.'
  },
  'call-coaching': {
    emoji:'ğŸ“', name:'Call Coaching',
    whenFires:'Fires on every completed call â€” grades performance.',
    triggers:[{event:'Gunner Webhook',label:'Call Completed',color:'purple'},{event:'Grading',label:'6-Factor Scorecard',color:'cyan'}],
    whatItDoes:['Grades call on 6 factors (rapport, discovery, objection handling, etc.)','Provides specific, actionable coaching notes','Scores A through F with detailed breakdown','Posts results to Gunner app leaderboard'],
    outputs:[
      {type:'api',label:'API',text:'Posts to Gunner app: grade (Aâ€“F), score (0â€“100), per-factor breakdown'},
      {type:'note',label:'NOTE',text:'Adds CRM note: "Call Grade: [B+] â€” Strong discovery, missed urgency signal at 4:20. Work on closing."'},
      {type:'data',label:'DATA',text:'Updates Gunner leaderboard: [LM name] score, rank, streak'},
    ],
    issues:null,
    learning:'Calibrates grading based on which call behaviors actually convert to appointments.'
  },
  'response-agent': {
    emoji:'ğŸ’¬', name:'Response Agent',
    whenFires:'Fires on every inbound text message from a lead.',
    triggers:[{event:'Webhook',label:'InboundMessage',color:'green'},{event:'Channel',label:'SMS from Lead',color:'pink'}],
    whatItDoes:['Classifies intent: interest, brushoff, DNC, or scheduling','Generates contextual AI reply within seconds','Escalates to Follow-Up Closer on buying interest','Handles DNC requests automatically'],
    outputs:[
      {type:'sms',label:'SMS',text:'Sends AI reply: contextual response matching seller\'s tone and intent'},
      {type:'tag',label:'TAG',text:'Tags intent: "Interest", "Brushoff", "DNC Request", "Scheduling Intent"'},
      {type:'stage',label:'STAGE',text:'On interest: fires Follow-Up Closer agent'},
      {type:'data',label:'DATA',text:'On DNC: sets do_not_contact=true, removes from all sequences'},
      {type:'note',label:'NOTE',text:'Adds CRM note: "Inbound SMS classified as [intent]. AI replied: [summary]"'},
    ],
    issues:null,
    learning:'Tracks which reply styles drive engagement and adjusts tone and approach.'
  },
  'am-assistant': {
    emoji:'ğŸ¤', name:'AM Assistant',
    whenFires:'Fires on walkthrough, offer appointment, and made offer stages.',
    triggers:[{event:'Stage Change',label:'â†’ Walkthrough Apt',color:'purple'},{event:'Stage Change',label:'â†’ Offer Apt',color:'orange'},{event:'Stage Change',label:'â†’ Made Offer',color:'green'}],
    whatItDoes:['Briefs Kyle with comps, ARV, and seller profile','Calculates offer range based on comparable sales','Handles no-show path with re-engagement text','Creates follow-up tasks on offer rejection'],
    outputs:[
      {type:'task',label:'TASK',text:'Creates task for Kyle: "Review deal package for [name] at [address] â€” offer range $XXXkâ€“$XXXk"'},
      {type:'note',label:'NOTE',text:'Adds CRM note: "AM Brief: ARV $XXXk | Repairs $XXk | Offer range $XXXkâ€“$XXXk | [motivation summary]"'},
      {type:'sms',label:'SMS',text:'On no-show: sends re-engagement text to seller + creates LM reschedule task (24h)'},
      {type:'stage',label:'STAGE',text:'On no-show: moves to Pending Apt stage for reschedule'},
      {type:'task',label:'TASK',text:'On offer rejected: creates task "Follow up with offer â€” due 1 week" + fires Bucket Re-eval'},
    ],
    issues:null,
    learning:'Refines comp selection and ARV estimates based on which deals actually close.'
  },
  'apt-prep': {
    emoji:'ğŸ“…', name:'Appointment Prep',
    whenFires:'Fires when a lead enters any appointment stage.',
    triggers:[{event:'Stage Change',label:'â†’ Pending Apt',color:'cyan'},{event:'Stage Change',label:'â†’ Walkthrough Apt',color:'purple'},{event:'Stage Change',label:'â†’ Offer Apt',color:'orange'}],
    whatItDoes:['Pulls comparable sales from the area','Estimates ARV and repair costs','Creates seller motivation brief','Packages everything for Kyle before the appointment'],
    outputs:[
      {type:'task',label:'TASK',text:'Creates task for Kyle: "Apt prep ready for [name] at [address] â€” [date/time]"'},
      {type:'note',label:'NOTE',text:'Adds CRM note: "Apt Package: [3-5] comps | ARV: $XXXk | Est. repairs: $XXk | Motivation: [summary]"'},
      {type:'data',label:'DATA',text:'Stores comp data, ARV estimate, repair estimate on contact record'},
    ],
    issues:null,
    learning:'Gets better at repair estimates based on walkthrough feedback and actual rehab costs.'
  },
  'offer-chase': {
    emoji:'ğŸ’°', name:'Offer Chase',
    whenFires:'Fires when an offer is made â€” follows up until response.',
    triggers:[{event:'Stage Change',label:'â†’ Made Offer',color:'orange'},{event:'Schedule',label:'Day 3 / 7 / 14 Auto',color:'cyan'}],
    whatItDoes:['Day 3, Day 7, Day 14 follow-up sequence to seller','Personalizes messages based on offer details and seller situation','Escalates if no response after 14 days','Tracks seller engagement signals'],
    outputs:[
      {type:'sms',label:'SMS',text:'Day 3: "Just wanted to check if you\'ve had a chance to review our offer on [address]..."'},
      {type:'sms',label:'SMS',text:'Day 7: "Wanted to circle back on our offer of $XXXk for [address]..."'},
      {type:'sms',label:'SMS',text:'Day 14: "Our offer is still on the table for [address]. Would love to make this work."'},
      {type:'task',label:'TASK',text:'After Day 14 with no reply: creates task for Kyle "Offer expired â€” call seller or close out"'},
    ],
    issues:null,
    learning:'Tracks which follow-up timing and messaging converts and adjusts intervals.'
  },
  'offer-reply': {
    emoji:'ğŸ“©', name:'Offer Reply',
    whenFires:'Fires when a seller responds to an offer.',
    triggers:[{event:'Webhook',label:'InboundMessage',color:'green'},{event:'Pipeline',label:'Sales â†’ Made Offer',color:'orange'}],
    whatItDoes:['Classifies seller response (accept, counter, reject, stall)','Routes to appropriate next action','Notifies Kyle immediately on positive signals','Creates tasks for negotiation follow-up'],
    outputs:[
      {type:'tag',label:'TAG',text:'Tags response: "Offer Accepted", "Counter Offer", "Offer Rejected", "Stalling"'},
      {type:'task',label:'TASK',text:'On accept: creates task for Kyle "Seller accepted â€” send to TC immediately"'},
      {type:'stage',label:'STAGE',text:'On accept: moves opportunity â†’ Under Contract'},
      {type:'task',label:'TASK',text:'On counter: creates task for Kyle "Counter offer received â€” $XXXk â€” respond within 24h"'},
      {type:'note',label:'NOTE',text:'Adds CRM note: "Offer Reply: [classification]. Seller said: [key quote from message]"'},
    ],
    issues:null,
    learning:'Learns to recognize positive buying signals earlier in conversation.'
  },
  'follow-up-organizer': {
    emoji:'ğŸ“Š', name:'Follow-Up Organizer',
    whenFires:'Fires on follow-up bucket placement (1mo, 4mo, 1yr).',
    triggers:[{event:'Stage Change',label:'â†’ Follow Up 1mo',color:'cyan'},{event:'Stage Change',label:'â†’ Follow Up 4mo',color:'purple'},{event:'Stage Change',label:'â†’ Follow Up 1yr',color:'orange'}],
    whatItDoes:['Organizes follow-up queue by priority','Schedules touches at correct intervals per bucket','1mo: 7-day intervals (6 touches), 4mo: 20-day intervals, 1yr: 60-day intervals','Hands off to Follow-Up Messenger for execution'],
    outputs:[
      {type:'data',label:'DATA',text:'Sets follow_up_bucket, touch_number, next_touch_date on contact'},
      {type:'stage',label:'STAGE',text:'1mo complete â†’ moves to 4mo bucket | 4mo complete â†’ moves to 1yr | 1yr complete â†’ Dead Lead'},
      {type:'note',label:'NOTE',text:'Adds CRM note: "Organized into [1mo] bucket â€” Touch 1/6 scheduled for [date]"'},
    ],
    issues:null,
    learning:'Optimizes bucket placement based on which leads re-engage from which intervals.'
  },
  'follow-up-messenger': {
    emoji:'ğŸ’Œ', name:'Follow-Up Messenger',
    whenFires:'Fires on scheduled follow-up touch.',
    triggers:[{event:'Schedule',label:'Cadence Timer',color:'green'},{event:'Source',label:'Follow-Up Queue',color:'cyan'}],
    whatItDoes:['Sends personalized follow-up message','Varies approach based on touch number','References previous conversation context','Respects send window and contact preferences'],
    outputs:[
      {type:'sms',label:'SMS',text:'Sends: "Hey [name], it\'s been a while since we talked about [address]. Anything changed? â€” [LM]"'},
      {type:'note',label:'NOTE',text:'Adds CRM note: "Follow-up touch #X/6 sent â€” [bucket] bucket, Day [N]"'},
      {type:'data',label:'DATA',text:'Updates touch_number, last_follow_up_date on contact'},
    ],
    issues:null,
    learning:'Tracks which follow-up messages re-engage leads and improves templates.'
  },
  'follow-up-closer': {
    emoji:'ğŸ”¥', name:'Follow-Up Closer',
    whenFires:'Fires when Response Agent detects scheduling intent or buying interest.',
    triggers:[{event:'Response Agent',label:'Interest Detected',color:'green'},{event:'Intent',label:'Scheduling / Buying',color:'pink'}],
    whatItDoes:['Engages lead with appointment-setting language','Confirms availability and suggests times','Creates appointment in GHL on confirmation','Transitions lead out of follow-up bucket'],
    outputs:[
      {type:'sms',label:'SMS',text:'Sends: "Great to hear from you! Kyle can meet [day] at [time] â€” does that work?"'},
      {type:'stage',label:'STAGE',text:'On confirmation: moves opportunity â†’ Pending Apt'},
      {type:'task',label:'TASK',text:'Creates task for Kyle: "Appointment confirmed with [name] at [address] â€” [date/time]"'},
      {type:'data',label:'DATA',text:'Clears follow-up bucket, sets appointment_date, cancels drip permanently'},
    ],
    issues:null,
    learning:'Learns which closing approaches work best for re-engaged leads.'
  },
  'ghosted-agent': {
    emoji:'ğŸ‘»', name:'Ghosted Agent',
    whenFires:'Fires when a lead goes silent for 14+ days.',
    triggers:[{event:'Stage Change',label:'â†’ Ghosted',color:'orange'},{event:'Condition',label:'14+ Days No Contact',color:'cyan'}],
    whatItDoes:['Sends breakup text to prompt a response','Sends new comp email with recent area sales','Drops personalized voicemail','Varies approach based on lead history'],
    outputs:[
      {type:'sms',label:'SMS',text:'Sends breakup: "No hard feelings if you\'ve decided not to sell [address]. Just wanted to close the loop."'},
      {type:'email',label:'EMAIL',text:'Sends comp update: "3 homes near [address] just sold â€” here\'s what yours could be worth"'},
      {type:'note',label:'NOTE',text:'Adds CRM note: "Ghosted re-engagement sequence started â€” breakup text sent"'},
    ],
    issues:null,
    learning:'Tracks which re-engagement tactics get responses and prioritizes them.'
  },
  'bucket-reeval': {
    emoji:'ğŸ”„', name:'Bucket Re-eval',
    whenFires:'Fires on any non-positive seller reply during follow-up.',
    triggers:[{event:'Webhook',label:'InboundMessage',color:'green'},{event:'Condition',label:'Non-Positive Reply',color:'orange'}],
    whatItDoes:['AI evaluates seller response sentiment','Determines if bucket reassignment needed','Moves lead to appropriate follow-up tier','Updates pipeline stage automatically'],
    outputs:[
      {type:'stage',label:'STAGE',text:'Moves to new bucket: 1mo â†’ 4mo â†’ 1yr based on AI sentiment analysis'},
      {type:'note',label:'NOTE',text:'Adds CRM note: "Bucket Re-eval: Seller replied [negative]. Moving from [1mo] â†’ [4mo]"'},
      {type:'data',label:'DATA',text:'Updates follow_up_bucket, resets touch_number to 1'},
    ],
    issues:null,
    learning:'Gets better at predicting which bucket produces the best re-engagement rates.'
  },
  'already-sold-agent': {
    emoji:'ğŸ ', name:'Already Sold Agent',
    whenFires:'Fires when a seller says the property was already sold.',
    triggers:[{event:'AI Classification',label:'\"Already Sold\" Detected',color:'orange'},{event:'Verification',label:'County Records Check',color:'cyan'}],
    whatItDoes:['Verifies sale against county records','If confirmed sold â†’ marks as Dead Lead','If no county record found â†’ marks as Under Contract for re-engagement','Prevents wasted follow-up on closed deals'],
    outputs:[
      {type:'api',label:'API',text:'Queries county records for recent sale at [address]'},
      {type:'stage',label:'STAGE',text:'Confirmed sold: moves opportunity â†’ Dead Lead'},
      {type:'stage',label:'STAGE',text:'No record found: moves opportunity â†’ Under Contract (re-engage)'},
      {type:'note',label:'NOTE',text:'Adds CRM note: "Already Sold check: [Confirmed/Not confirmed] via county records"'},
      {type:'tag',label:'TAG',text:'Tags: "Confirmed Sold" or "Claimed Sold â€” Unverified"'},
    ],
    issues:null,
    learning:'Builds database of sold properties to catch duplicates faster.'
  },
  'contract-bot': {
    emoji:'ğŸ“', name:'Contract Bot',
    whenFires:'Fires when a deal moves to Under Contract.',
    triggers:[{event:'Stage Change',label:'â†’ Under Contract',color:'green'},{event:'Pipeline',label:'Sales Process',color:'cyan'}],
    whatItDoes:['Sends confirmation SMS to seller','Creates AM task with 1-hour deadline','Initiates TC and Dispo package workflows','Logs contract milestone'],
    outputs:[
      {type:'sms',label:'SMS',text:'Sends: "Great news [name]! Everything is official on [address]. Our team will be in touch with next steps."'},
      {type:'task',label:'TASK',text:'Creates task for Kyle: "UC â€” Get details to TC and Dispo within 1 hour" (1hr deadline)'},
      {type:'api',label:'API',text:'Fires TC Packager agent â†’ compiles title company package'},
      {type:'api',label:'API',text:'Fires Dispo Packager agent â†’ creates buyer-facing deal blast'},
      {type:'note',label:'NOTE',text:'Adds CRM note: "Under Contract confirmed. TC + Dispo packages initiated."'},
    ],
    issues:null,
    learning:'Tracks which confirmation messages reduce seller cold feet.'
  },
  'uc-monitor': {
    emoji:'ğŸ“¡', name:'UC Monitor',
    whenFires:'Runs periodic checks on all under-contract deals.',
    triggers:[{event:'Stage Change',label:'â†’ Under Contract',color:'green'},{event:'Schedule',label:'Every 30min Check',color:'cyan'}],
    whatItDoes:['Monitors seller communication activity','Sends proactive check-ins if seller goes quiet','Creates urgent tasks on seller concerns','Tracks days-to-close and flags delays'],
    outputs:[
      {type:'sms',label:'SMS',text:'If quiet 5+ days: "Hey [name], just checking in on [address]. Everything still on track?"'},
      {type:'task',label:'TASK',text:'On seller concern: creates URGENT task for Kyle "Seller expressed concern â€” call ASAP"'},
      {type:'alert',label:'ALERT',text:'If 10+ days no contact: escalation alert to Corey'},
      {type:'note',label:'NOTE',text:'Adds CRM note: "UC Monitor: Day [X] of contract. Seller [active/quiet]. Status: [on track/at risk]"'},
    ],
    issues:null,
    learning:'Learns which check-in timing prevents deals from falling through.'
  },
  'tc-packager': {
    emoji:'ğŸ“¦', name:'TC Packager',
    whenFires:'Fires when a deal goes under contract.',
    triggers:[{event:'Stage Change',label:'â†’ Under Contract',color:'green'},{event:'Auto',label:'Fires with Contract Bot',color:'purple'}],
    whatItDoes:['Compiles all deal documents into TC package','Prepares title company submission','Includes property details, contract terms, contact info','Sends to title company for processing'],
    outputs:[
      {type:'email',label:'EMAIL',text:'Sends TC package: property address, seller info, contract terms, purchase price, closing date'},
      {type:'note',label:'NOTE',text:'Adds CRM note: "TC Package sent to [title company] â€” awaiting title search"'},
      {type:'task',label:'TASK',text:'Creates task: "Confirm TC received package â€” follow up if no response in 24h"'},
    ],
    issues:null,
    learning:'Streamlines package format based on title company feedback.'
  },
  'dispo-packager': {
    emoji:'ğŸ“¦', name:'Dispo Packager',
    whenFires:'Fires when a deal goes under contract.',
    triggers:[{event:'Stage Change',label:'â†’ Under Contract',color:'green'},{event:'Auto',label:'Fires with Contract Bot',color:'purple'}],
    whatItDoes:['Creates buyer-facing deal package','Includes property photos, ARV, asking price, repair estimates','Blasts to qualified buyer list','Tracks buyer interest and responses'],
    outputs:[
      {type:'email',label:'EMAIL',text:'Blasts to [XX] buyers: "[address] â€” $XXXk | ARV $XXXk | Repairs $XXk | [X] bed/[X] bath"'},
      {type:'sms',label:'SMS',text:'SMS blast to top buyers: "New deal just hit â€” [address] at $XXXk. Reply YES for details."'},
      {type:'note',label:'NOTE',text:'Adds CRM note: "Dispo package sent to [XX] buyers. [X] opened, [X] replied."'},
      {type:'stage',label:'STAGE',text:'Creates opportunity in Dispo Pipeline â†’ New Deal stage'},
    ],
    issues:null,
    learning:'Learns which deal presentation formats get faster buyer responses.'
  },
  'post-close-bot': {
    emoji:'ğŸ‰', name:'Post-Close Bot',
    whenFires:'Fires after a deal closes (Purchased stage).',
    triggers:[{event:'Stage Change',label:'â†’ Purchased',color:'green'},{event:'Schedule',label:'24h / 48h / 7d Drip',color:'cyan'}],
    whatItDoes:['Sends thank you text at 24 hours','Requests Google review at 48 hours','Sends referral ask at 7 days','Maintains seller relationship post-close'],
    outputs:[
      {type:'sms',label:'SMS',text:'24h: "Thank you [name]! It was great working with you on [address]. Wishing you all the best."'},
      {type:'sms',label:'SMS',text:'48h: "Would you mind leaving us a quick Google review? [link] â€” it really helps!"'},
      {type:'sms',label:'SMS',text:'7d: "Hey [name], know anyone else thinking about selling? We\'d love to help them too."'},
      {type:'note',label:'NOTE',text:'Adds CRM note: "Post-close sequence: [touch X/3] sent"'},
    ],
    issues:null,
    learning:'Tracks which post-close messages generate referrals and reviews.'
  },
  'deal-intake': {
    emoji:'ğŸ“¥', name:'Deal Intake',
    whenFires:'Fires when a new deal enters the dispo pipeline.',
    triggers:[{event:'Stage Change',label:'â†’ New Deal',color:'green'},{event:'Pipeline',label:'Dispo Process',color:'purple'}],
    whatItDoes:['Validates deal information completeness','Creates deal profile with key metrics','Initiates buyer matching process','Logs deal entry'],
    outputs:[
      {type:'data',label:'DATA',text:'Creates deal profile: address, purchase price, ARV, repair estimate, spread'},
      {type:'api',label:'API',text:'Fires Buyer Matcher agent to find matching buyers'},
      {type:'note',label:'NOTE',text:'Adds note: "New deal intake complete. Spread: $XXk. Buyer matching initiated."'},
    ],
    issues:null,
    learning:'Identifies which deal data points predict faster closings.'
  },
  'buyer-matcher': {
    emoji:'ğŸ¯', name:'Buyer Matcher',
    whenFires:'Fires on new deal intake.',
    triggers:[{event:'Stage Change',label:'â†’ New Deal',color:'green'},{event:'Auto',label:'Fires with Deal Intake',color:'purple'}],
    whatItDoes:['Matches deal criteria against buyer preferences','Ranks buyers by likelihood to close','Considers geography, price range, property type','Generates priority buyer list'],
    outputs:[
      {type:'data',label:'DATA',text:'Generates ranked buyer list: [XX] matches sorted by close probability'},
      {type:'note',label:'NOTE',text:'Adds note: "Buyer match complete. Top match: [buyer name] â€” XX% match score"'},
    ],
    issues:null,
    learning:'Improves matching based on which buyers actually close on which deal types.'
  },
  'deal-blaster': {
    emoji:'ğŸ“£', name:'Deal Blaster',
    whenFires:'Fires when deal is cleared to send.',
    triggers:[{event:'Stage Change',label:'â†’ Clear to Send',color:'green'},{event:'Pipeline',label:'Dispo Process',color:'purple'}],
    whatItDoes:['Sends deal to matched buyer list','Uses email and SMS channels','Tracks open rates and responses','Manages blast timing for maximum engagement'],
    outputs:[
      {type:'email',label:'EMAIL',text:'Blast to [XX] buyers with deal package, photos, and terms'},
      {type:'sms',label:'SMS',text:'SMS to top [XX] buyers: "New deal â€” [address] at $XXXk. Reply YES for details."'},
      {type:'data',label:'DATA',text:'Tracks: [X] sent, [X] opened, [X] replied'},
    ],
    issues:null,
    learning:'Optimizes send times and messaging based on buyer response patterns.'
  },
  'offer-collector': {
    emoji:'ğŸ“¬', name:'Offer Collector',
    whenFires:'Fires when buyer offers come in.',
    triggers:[{event:'Stage Change',label:'â†’ Offers Received',color:'green'},{event:'Pipeline',label:'Dispo Process',color:'purple'}],
    whatItDoes:['Collects and organizes buyer offers','Compares offers side-by-side','Ranks by terms (price, closing speed, contingencies)','Presents summary to Esteban'],
    outputs:[
      {type:'note',label:'NOTE',text:'Adds note: "Offer received: [buyer] at $XXXk | Close in [X] days | [contingencies]"'},
      {type:'task',label:'TASK',text:'Creates task for Esteban: "Review [X] offers on [address] â€” top offer $XXXk"'},
      {type:'data',label:'DATA',text:'Stores offer comparison: price, speed, contingencies ranked'},
    ],
    issues:null,
    learning:'Learns which offer characteristics predict successful closings.'
  },
  'jv-router': {
    emoji:'ğŸ¤', name:'JV Router',
    whenFires:'Fires when a deal is flagged for JV partner.',
    triggers:[{event:'Stage Change',label:'â†’ With JV Partner',color:'purple'},{event:'Pipeline',label:'Dispo Process',color:'cyan'}],
    whatItDoes:['Routes deal to appropriate JV partner','Prepares JV-specific deal package','Manages communication flow','Tracks JV deal progress'],
    outputs:[
      {type:'email',label:'EMAIL',text:'Sends JV package to [partner name] with deal terms and split structure'},
      {type:'task',label:'TASK',text:'Creates task for Esteban: "JV deal sent to [partner] â€” follow up in 48h"'},
      {type:'note',label:'NOTE',text:'Adds note: "Routed to JV partner [name]. Split: XX/XX."'},
    ],
    issues:null,
    learning:'Identifies which JV partners close fastest on which deal types.'
  },
  'deal-terminator': {
    emoji:'ğŸš«', name:'Deal Terminator',
    whenFires:'Fires when a deal needs to be terminated.',
    triggers:[{event:'Stage Change',label:'â†’ Need to Terminate',color:'orange'},{event:'Pipeline',label:'Dispo Process',color:'cyan'}],
    whatItDoes:['Sends termination notice to all parties','Handles cancellation paperwork triggers','Updates pipeline status','Logs termination reason for future reference'],
    outputs:[
      {type:'email',label:'EMAIL',text:'Sends termination notice to buyer, seller, and title company'},
      {type:'stage',label:'STAGE',text:'Moves opportunity â†’ Terminated'},
      {type:'note',label:'NOTE',text:'Adds note: "Deal terminated. Reason: [reason]. Earnest release: [status]"'},
      {type:'task',label:'TASK',text:'Creates task: "Process earnest money release"'},
    ],
    issues:null,
    learning:'Identifies early warning signs of deals likely to terminate.'
  },
  'dispo-closer': {
    emoji:'ğŸ', name:'Dispo Closer',
    whenFires:'Fires when a buyer is under contract.',
    triggers:[{event:'Stage Change',label:'â†’ UC with Buyer',color:'green'},{event:'Pipeline',label:'Dispo Process',color:'purple'}],
    whatItDoes:['Manages buyer-side closing process','Coordinates between buyer, seller, and title','Sends milestone updates','Tracks days to close'],
    outputs:[
      {type:'sms',label:'SMS',text:'Milestone update to buyer: "Closing on [address] is on track for [date]"'},
      {type:'task',label:'TASK',text:'Creates task: "Confirm closing date with title â€” [X] days remaining"'},
      {type:'note',label:'NOTE',text:'Adds note: "Dispo closing: Day [X]. Status: [on track/delayed]. Est close: [date]"'},
    ],
    issues:null,
    learning:'Optimizes closing coordination based on historical timelines.'
  },
  'title-coordinator': {
    emoji:'ğŸ“‹', name:'Title Coordinator',
    whenFires:'Fires when deal is working with title company.',
    triggers:[{event:'Stage Change',label:'â†’ Working with Title',color:'cyan'},{event:'Pipeline',label:'Dispo Process',color:'purple'}],
    whatItDoes:['Manages title company communication','Tracks document submission status','Flags missing items','Sends reminders on deadlines'],
    outputs:[
      {type:'email',label:'EMAIL',text:'Reminder to TC: "Missing [document] for [address] â€” closing in [X] days"'},
      {type:'task',label:'TASK',text:'Creates task: "Follow up with title on [missing item]"'},
      {type:'alert',label:'ALERT',text:'If deadline at risk: escalation to Esteban + Corey'},
      {type:'note',label:'NOTE',text:'Adds note: "Title status: [X/Y] docs received. Missing: [list]"'},
    ],
    issues:null,
    learning:'Learns which title companies close fastest and flags potential delays early.'
  },
  'dispo-closing-agent': {
    emoji:'âœ…', name:'Dispo Closing Agent',
    whenFires:'Fires when a dispo deal closes.',
    triggers:[{event:'Stage Change',label:'â†’ Closed',color:'green'},{event:'Pipeline',label:'Dispo Process',color:'purple'}],
    whatItDoes:['Confirms closing with all parties','Calculates final profit/spread','Updates buyer reliability score','Logs closed deal metrics'],
    outputs:[
      {type:'sms',label:'SMS',text:'Sends to buyer + seller: "Closing confirmed on [address]! Congratulations."'},
      {type:'data',label:'DATA',text:'Logs deal: purchase $XXXk â†’ sold $XXXk â†’ profit $XXk | Days to close: [X]'},
      {type:'data',label:'DATA',text:'Updates buyer reliability score based on closing speed and communication'},
      {type:'note',label:'NOTE',text:'Adds note: "CLOSED. Spread: $XXk. Buyer: [name]. Days in pipeline: [X]"'},
    ],
    issues:null,
    learning:'Tracks profit margins by deal type to improve future pricing.'
  },
  'accountability': {
    emoji:'âš–ï¸', name:'Accountability',
    whenFires:'Runs on schedule â€” checks for overdue tasks across the team.',
    triggers:[{event:'Schedule',label:'Every 24h',color:'cyan'},{event:'Scans',label:'All Open GHL Tasks',color:'orange'}],
    whatItDoes:['Scans all open tasks for overdue items','Sends yellow flag at 15 min overdue','Sends orange alert to Jessica at 30 min','Sends red escalation to Corey at 60 min'],
    outputs:[
      {type:'alert',label:'ALERT',text:'ğŸŸ¡ 15min: "[LM name] has [X] tasks overdue" â€” sent to team member'},
      {type:'alert',label:'ALERT',text:'ğŸŸ  30min: "[LM name] still has [X] overdue" â€” escalated to Jessica'},
      {type:'alert',label:'ALERT',text:'ğŸ”´ 60min: "ESCALATION: [X] tasks overdue 60+ min" â€” sent to Corey'},
      {type:'note',label:'NOTE',text:'Adds note: "Accountability check: [X] tasks on time, [X] overdue"'},
    ],
    issues:null,
    learning:'Tracks which team members respond to which escalation tiers.'
  },
  'reality-check': {
    emoji:'ğŸ”¬', name:'Reality Check',
    whenFires:'Runs periodically to verify pipeline data integrity.',
    triggers:[{event:'Schedule',label:'Periodic Scan',color:'cyan'},{event:'Checks',label:'Pipeline Data Integrity',color:'purple'}],
    whatItDoes:['Verifies contact data against external sources','Catches duplicate opportunities','Flags stalled pipelines','Cross-references county records'],
    outputs:[
      {type:'alert',label:'ALERT',text:'Flags: "Duplicate opportunity found â€” [name] appears in [X] stages"'},
      {type:'alert',label:'ALERT',text:'Flags: "Pipeline stalled â€” [name] in [stage] for [X] days with no activity"'},
      {type:'tag',label:'TAG',text:'Tags: "Duplicate", "Stalled", "Data Mismatch"'},
      {type:'note',label:'NOTE',text:'Adds note: "Reality Check: [X] contacts verified, [X] issues found"'},
    ],
    issues:null,
    learning:'Builds patterns of common data errors to catch earlier.'
  },
  'callback-capture': {
    emoji:'ğŸ“²', name:'Callback Capture',
    whenFires:'Fires on every inbound call.',
    triggers:[{event:'Webhook',label:'Inbound Call',color:'green'},{event:'Source',label:'CallRail / GHL',color:'cyan'}],
    whatItDoes:['Captures inbound call details','Creates callback task for assigned LM','Logs call in CRM','Notifies team member immediately'],
    outputs:[
      {type:'task',label:'TASK',text:'Creates task for [LM]: "Callback â€” [name] called at [time]. Call back ASAP."'},
      {type:'note',label:'NOTE',text:'Adds note: "Inbound call from [name] at [time]. Duration: [Xs]. [Answered/Missed]"'},
      {type:'data',label:'DATA',text:'Updates last_call_date, inbound_call_count on contact'},
    ],
    issues:null,
    learning:'Tracks which callback response times lead to conversions.'
  },
  'stage-change-router': {
    emoji:'ğŸ”€', name:'Stage Change Router',
    whenFires:'Fires on every pipeline stage change.',
    triggers:[{event:'Webhook',label:'OpportunityStageUpdate',color:'green'},{event:'Routes to',label:'Correct Agent Handler',color:'cyan'}],
    whatItDoes:['Routes stage changes to correct agent handlers','Validates stage transition is legitimate','Logs all pipeline movement','Prevents duplicate agent fires'],
    outputs:[
      {type:'api',label:'API',text:'Fires agent(s): [list of agents triggered by this stage change]'},
      {type:'data',label:'DATA',text:'Logs: "[name] moved from [old stage] â†’ [new stage] at [time]"'},
      {type:'alert',label:'ALERT',text:'If invalid transition detected: blocks agents and flags for review'},
    ],
    issues:null,
    learning:'Identifies unusual stage transitions that may indicate data errors.'
  },
  'morning-briefing': {
    emoji:'â˜€ï¸', name:'Morning Briefing',
    whenFires:'Fires daily at 8:00 AM CST.',
    triggers:[{event:'Schedule',label:'Daily 8:00 AM CST',color:'cyan'},{event:'Scans',label:'Last 24h Activity',color:'purple'}],
    whatItDoes:['Scans last 24 hours of activity','Compiles key metrics and alerts','Generates Telegram-ready briefing','Highlights items needing attention'],
    outputs:[
      {type:'api',label:'TELEGRAM',text:'Sends morning briefing: "ğŸ“Š Yesterday: [X] new leads, [X] calls, [X] texts, [X] appointments, [X] errors"'},
      {type:'data',label:'DATA',text:'Compiles: leads processed, calls graded, tasks completed, overdue items, pipeline movement'},
      {type:'alert',label:'ALERT',text:'Highlights: "[X] items need attention today" with specific action items'},
    ],
    issues:null,
    learning:'Adapts briefing content based on which sections Corey engages with most.'
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRIGGER MAP DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TRIGGERS = [
  {event:'ğŸ†• New Lead Enters Pipeline',sub:'Stage: New Lead',agents:['data-hygiene','lead-iq','initial-outreach'],output:'Lead cleaned, scored, profiled, first text sent within 3 min'},
  {event:'ğŸŸ¡ Lead â†’ Warm',sub:'Stage: Warm',agents:['working-drip'],output:'24-touch drip activated over 104 days'},
  {event:'ğŸ”¥ Lead â†’ Hot',sub:'Stage: Hot',agents:['working-drip'],output:'Accelerated drip sequence'},
  {event:'ğŸ“… Pending Appointment',sub:'Stage: Pending Apt',agents:['apt-prep'],output:'Comp package prepped for Kyle'},
  {event:'ğŸ  Walkthrough',sub:'Stage: Walkthrough',agents:['apt-prep','am-assistant'],output:'Kyle briefed with comps, ARV, motivation profile'},
  {event:'ğŸ’¼ Offer Appointment',sub:'Stage: Offer Apt',agents:['apt-prep','am-assistant'],output:'Offer range calculated, seller profile prepped'},
  {event:'ğŸ’° Made Offer',sub:'Stage: Made Offer',agents:['offer-chase'],output:'Day 3/7/14 follow-up sequence started'},
  {event:'ğŸ“ Under Contract',sub:'Stage: UC',agents:['contract-bot','uc-monitor','tc-packager','dispo-packager'],output:'Confirmation sent, TC + Dispo packages fired'},
  {event:'ğŸ‰ Purchased',sub:'Stage: Purchased',agents:['post-close-bot'],output:'Thank you (24h), Review (48h), Referral (7d)'},
  {event:'ğŸ‘» Ghosted',sub:'14+ days silent',agents:['ghosted-agent'],output:'Breakup text + comp email + voicemail drop'},
  {event:'ğŸ“Š Follow-Up Bucket',sub:'1mo / 4mo / 1yr',agents:['follow-up-organizer','follow-up-messenger'],output:'Scheduled touches at correct intervals'},
  {event:'ğŸ’¬ Inbound SMS',sub:'Lead texts in',agents:['response-agent'],output:'AI reply within seconds, escalation if needed'},
  {event:'ğŸ“ Inbound Call',sub:'Lead calls in',agents:['callback-capture'],output:'Call logged, callback task created'},
  {event:'ğŸ“ Call Completed',sub:'Any call ends',agents:['lm-assistant','call-coaching'],output:'CRM note + coaching grade posted'},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let selectedAgent = null;
let agentStats = {}; // populated from API
let liveEntries = [];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER SIDEBAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSidebar() {
  const el = document.getElementById('sidebar');
  el.innerHTML = GROUPS.map(g => {
    const rows = g.agents.map(id => {
      const a = AGENTS[id];
      if (!a) return '';
      const stats = agentStats[id] || {};
      const status = stats.lastAction || 'No activity yet';
      const dotClass = stats.errors > 0 ? 'dot-error' : stats.today > 0 ? 'dot-active' : 'dot-idle';
      return `<div class="agent-row${selectedAgent===id?' selected':''}" data-id="${id}" onclick="selectAgent('${id}')">
        <span class="ar-emoji">${a.emoji}</span>
        <div class="ar-info">
          <div class="ar-name">${a.name}</div>
          <div class="ar-status">${status}</div>
        </div>
        <span class="ar-toggle">â€”</span>
        <span class="ar-dot ${dotClass}"></span>
      </div>`;
    }).join('');
    return `<div class="sidebar-group">
      <div class="sidebar-group-label">${g.label}</div>
      ${rows}
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER DETAIL PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDetail(id) {
  const el = document.getElementById('detailPanel');
  const a = AGENTS[id];
  if (!a) { el.innerHTML = '<div class="detail-empty">Agent not found</div>'; return; }
  const stats = agentStats[id] || {};

  const pillClass = (c) => c==='cyan'?'pill-cyan':c==='purple'?'pill-purple':c==='orange'?'pill-orange':c==='pink'?'pill-pink':'';
  const triggersHtml = a.triggers.map(t =>
    `<span class="pill ${pillClass(t.color)}"><span class="pill-event">${t.event||'trigger'}</span><span class="pill-stage">${t.label}</span></span>`
  ).join('');

  const bulletsHtml = a.whatItDoes.map(b => `<li>${b}</li>`).join('');

  const typeClass = (t) => ({sms:'ot-sms',task:'ot-task',note:'ot-note',tag:'ot-tag',stage:'ot-stage',email:'ot-email',api:'ot-api',data:'ot-data',alert:'ot-alert'}[t]||'ot-data');
  const outputsHtml = a.outputs && a.outputs.length
    ? `<div class="detail-section">
        <div class="detail-section-title" style="color:var(--text)">ğŸ“‹ EXACT OUTPUTS</div>
        <div class="output-list">${a.outputs.map(o =>
          `<div class="output-item"><span class="output-type ${typeClass(o.type)}">${o.label}</span><span class="output-text">${o.text}</span></div>`
        ).join('')}</div>
      </div>` : '';

  const issuesHtml = a.issues && a.issues.length
    ? `<div class="detail-section">
        <div class="detail-section-title dst-red">âš ï¸ KNOWN ISSUES / RED FLAGS</div>
        <ul class="issues-list">${a.issues.map(i => `<li>${i}</li>`).join('')}</ul>
      </div>` : '';

  el.innerHTML = `
    <div class="detail-section">
      <div class="detail-section-title dst-cyan">âš¡ WHEN DOES IT FIRE?</div>
      <div class="detail-text">${a.whenFires}</div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title dst-green">ğŸ”— TRIGGER</div>
      <div class="trigger-pills">${triggersHtml}</div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title dst-green">âœ… WHAT IT DOES WHEN IT RUNS</div>
      <ul class="detail-bullets">${bulletsHtml}</ul>
    </div>
    ${outputsHtml}
    ${issuesHtml}
    <div class="detail-section">
      <div class="detail-section-title dst-purple">ğŸ§  HOW IT GETS SMARTER OVER TIME</div>
      <div class="learning-text">${a.learning}</div>
    </div>
    <div class="detail-stats">
      <div class="ds-item"><div class="ds-val val-green">${stats.today||0}</div><div class="ds-label">Today</div></div>
      <div class="ds-item"><div class="ds-val val-cyan">${stats.total||0}</div><div class="ds-label">Total</div></div>
      <div class="ds-item"><div class="ds-val val-red">${stats.errors||0}</div><div class="ds-label">Errors</div></div>
      <div class="ds-item"><div class="ds-val">${stats.lastRun||'â€“'}</div><div class="ds-label">Last Run</div></div>
    </div>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER TRIGGERS TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTriggers() {
  const el = document.getElementById('triggersPanel');
  el.innerHTML = TRIGGERS.map(t => {
    const agentPills = t.agents.map(id => {
      const a = AGENTS[id];
      return a ? `<span class="trig-agent-pill">${a.emoji} ${a.name}</span>` : `<span class="trig-agent-pill">${id}</span>`;
    }).join('');
    return `<div class="trig-card">
      <div class="trig-event-box">
        <div class="trig-event-icon">${t.event.split(' ')[0]}</div>
        <div class="trig-event-label">${t.event.replace(/^[^\s]+\s/,'')}</div>
        <div class="trig-event-sub">${t.sub}</div>
      </div>
      <span class="trig-arrow">â†’</span>
      <div class="trig-agents-list">${agentPills}</div>
      <span class="trig-arrow">â†’</span>
      <div class="trig-output-box"><strong>Output</strong>${t.output}</div>
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER FEED (Leads tab)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderFeed() {
  const el = document.getElementById('feedPanel');
  if (!liveEntries.length) {
    el.innerHTML = '<div style="color:var(--dim);text-align:center;padding:60px">Live feed â€” waiting for activity...</div>';
    return;
  }
  el.innerHTML = liveEntries.slice(0, 100).map(e => {
    const a = AGENTS[e.agent] || { emoji:'â“', name: e.agent };
    const time = e.timestamp ? new Date(e.timestamp).toLocaleTimeString() : '';
    return `<div class="feed-entry">
      <div class="feed-top">
        <span class="feed-agent">${a.emoji} ${a.name}</span>
        <span class="feed-time">${time}</span>
      </div>
      <div class="feed-action">${e.action || JSON.stringify(e)}</div>
      <div class="feed-badges">
        <span class="${e.result==='error'?'fb-error':'fb-success'}">${e.result==='error'?'âŒ':'âœ…'} ${e.result||'success'}</span>
        ${e.contact?`<span class="fb-contact">ğŸ‘¤ ${e.contact}</span>`:''}
      </div>
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INTERACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectAgent(id) {
  selectedAgent = id;
  renderSidebar();
  renderDetail(id);
  // ensure agents tab is active
  switchTab('agents');
}

const TAB_DESCS = { leads:'Live audit feed â€” every action in real-time', agents:'What each AI agent is doing', triggers:'Which events fire which agents' };

function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
  document.getElementById('tabDesc').textContent = TAB_DESCS[tab] || '';
  
  document.getElementById('sidebar').style.display = tab === 'agents' ? '' : 'none';
  document.getElementById('detailPanel').style.display = tab === 'agents' ? '' : 'none';
  document.getElementById('triggersPanel').style.display = tab === 'triggers' ? '' : 'none';
  document.getElementById('feedPanel').style.display = tab === 'leads' ? '' : 'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOAD REAL DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(async function loadData() {
  try {
    const res = await fetch('/api/audit');
    const data = await res.json();
    if (Array.isArray(data) && data.length > 0) {
      liveEntries = data.map(e => ({
        agent: e.agentId || e.agent || 'unknown',
        action: e.action || e.message || '',
        result: e.result || (e.error ? 'error' : 'success'),
        contact: e.contactName || e.contact || '',
        timestamp: e.timestamp
      }));
      
      // Build stats per agent
      const now = Date.now();
      const todayStart = new Date(); todayStart.setHours(0,0,0,0);
      data.forEach(e => {
        const id = e.agentId || e.agent;
        if (!id) return;
        if (!agentStats[id]) agentStats[id] = { today:0, total:0, errors:0, lastRun:null, lastAction:null };
        agentStats[id].total++;
        const ts = e.timestamp ? new Date(e.timestamp).getTime() : 0;
        if (ts >= todayStart.getTime()) agentStats[id].today++;
        if (e.result === 'error' || e.error) agentStats[id].errors++;
        if (!agentStats[id].lastRun || ts > new Date(agentStats[id].lastRun).getTime()) {
          agentStats[id].lastRun = e.timestamp ? new Date(e.timestamp).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : null;
          agentStats[id].lastAction = (e.action || e.message || '').slice(0, 50) + ((e.action||'').length > 50 ? 'â€¦' : '');
        }
      });
      
      renderSidebar();
      renderFeed();
    }
  } catch (e) { console.log('API unavailable, using empty state', e); }
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEBSOCKET LIVE FEED
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function initWebSocket() {
  let ws, reconnectTimer;
  function connect() {
    const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
    ws = new WebSocket(proto + '//' + location.host + '/ws/audit');
    ws.onopen = () => { console.log('[ws] connected'); clearTimeout(reconnectTimer); };
    ws.onmessage = (evt) => {
      try {
        const entry = JSON.parse(evt.data);
        const mapped = {
          agent: entry.agent || 'unknown',
          action: entry.action || JSON.stringify(entry),
          result: entry.result || 'success',
          contact: entry.contactId || entry.contactName || '',
          timestamp: entry.timestamp || Date.now()
        };
        liveEntries.unshift(mapped);
        
        // Update stats
        const id = mapped.agent;
        if (!agentStats[id]) agentStats[id] = { today:0, total:0, errors:0, lastRun:null, lastAction:null };
        agentStats[id].total++;
        agentStats[id].today++;
        if (mapped.result === 'error') agentStats[id].errors++;
        agentStats[id].lastRun = new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
        agentStats[id].lastAction = mapped.action.slice(0, 50);
        
        renderSidebar();
        renderFeed();
        if (selectedAgent === id) renderDetail(id);
      } catch (e) { console.error('[ws] parse error:', e); }
    };
    ws.onclose = () => { reconnectTimer = setTimeout(connect, 3000); };
    ws.onerror = () => { ws.close(); };
  }
  connect();
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
renderSidebar();
renderTriggers();
switchTab('agents');
</script>
</body>
</html>
