<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ”« Gunner Audit Log</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0f172a;--card:#1e293b;--border:#334155;--glow:rgba(59,130,246,.15);--blue:#3b82f6;--cyan:#06b6d4;--green:#22c55e;--yellow:#eab308;--orange:#f97316;--red:#ef4444;--purple:#a855f7;--pink:#ec4899;--text:#f1f5f9;--muted:#94a3b8;--dim:#64748b}
html{scroll-behavior:smooth}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);line-height:1.6;overflow-x:hidden}
a{color:var(--cyan);text-decoration:none;transition:color .2s}
a:hover{color:#fff}
.container{max-width:1400px;margin:0 auto;padding:0 20px}

/* â”€â”€ HEADER â”€â”€ */
.header{padding:24px 0;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100;background:rgba(15,23,42,.95);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px)}
.header-inner{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
.header-left{display:flex;align-items:center;gap:16px}
.header-title{font-size:1.5rem;font-weight:800;background:linear-gradient(135deg,#fff,var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.header-sub{color:var(--muted);font-size:.85rem}
.live-badge{display:inline-flex;align-items:center;gap:6px;background:rgba(34,197,94,.15);border:1px solid rgba(34,197,94,.3);color:var(--green);padding:6px 14px;border-radius:999px;font-size:.8rem;font-weight:600}
.live-dot{width:8px;height:8px;border-radius:50%;background:var(--green);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.4;transform:scale(.8)}}
.nav-links{display:flex;gap:16px;font-size:.85rem}
.nav-links a{color:var(--muted)}
.nav-links .current{color:var(--cyan);font-weight:700}

/* â”€â”€ SECTION TITLES â”€â”€ */
.section{padding:40px 0 20px}
.section-title{font-size:1.6rem;font-weight:800;margin-bottom:6px;display:flex;align-items:center;gap:10px}
.section-desc{color:var(--muted);font-size:.95rem;margin-bottom:24px;max-width:700px}

/* â”€â”€ HOW IT WORKS â”€â”€ */
.how-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-bottom:32px}
.how-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:28px;position:relative;overflow:hidden}
.how-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.how-card.hc1::before{background:var(--cyan)}
.how-card.hc2::before{background:var(--green)}
.how-card.hc3::before{background:var(--purple)}
.how-card h3{font-size:1.1rem;margin-bottom:10px;display:flex;align-items:center;gap:8px}
.how-card p{color:var(--muted);font-size:.9rem;line-height:1.7}

/* Example cards */
.example-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:16px;margin-top:20px}
.ex-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px;position:relative}
.ex-card .ex-label{position:absolute;top:-10px;right:12px;background:var(--purple);color:#fff;font-size:.65rem;font-weight:700;padding:3px 10px;border-radius:6px;text-transform:uppercase;letter-spacing:.5px}
.ex-card .ex-agent{font-size:.8rem;color:var(--cyan);font-weight:600;margin-bottom:6px}
.ex-card .ex-action{font-size:.95rem;margin-bottom:8px}
.ex-card .ex-meta{display:flex;gap:10px;font-size:.75rem;color:var(--dim)}
.ex-card .ex-badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:.7rem;font-weight:600}

/* â”€â”€ TRIGGER MAP â”€â”€ */
.trigger-map{display:grid;gap:16px;margin-bottom:32px}
.trigger-row{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;display:flex;align-items:center;gap:0;overflow-x:auto;position:relative}
.trigger-row::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;border-radius:14px 14px 0 0}
.trigger-row.phase-intake::before{background:var(--cyan)}
.trigger-row.phase-working::before{background:var(--blue)}
.trigger-row.phase-apt::before{background:var(--purple)}
.trigger-row.phase-offer::before{background:var(--orange)}
.trigger-row.phase-close::before{background:var(--green)}
.trigger-row.phase-followup::before{background:var(--yellow)}
.trigger-row.phase-comms::before{background:var(--pink)}
.trig-event{background:rgba(255,255,255,.05);border:1px solid var(--border);border-radius:10px;padding:10px 14px;min-width:140px;text-align:center;flex-shrink:0}
.trig-event .trig-icon{font-size:1.2rem;margin-bottom:4px}
.trig-event .trig-label{font-size:.78rem;font-weight:700;color:var(--text)}
.trig-event .trig-sub{font-size:.68rem;color:var(--dim);margin-top:2px}
.trig-arrow{color:var(--dim);font-size:1.1rem;margin:0 8px;flex-shrink:0}
.trig-agents{display:flex;gap:6px;flex-wrap:wrap;flex-shrink:0}
.trig-agent{background:rgba(59,130,246,.1);border:1px solid rgba(59,130,246,.2);border-radius:8px;padding:6px 10px;font-size:.72rem;font-weight:600;color:var(--cyan);white-space:nowrap}
.trig-output{background:rgba(34,197,94,.08);border:1px solid rgba(34,197,94,.2);border-radius:10px;padding:10px 14px;min-width:160px;font-size:.78rem;color:var(--green);flex-shrink:0;margin-left:8px}
.trig-output strong{display:block;font-size:.68rem;color:var(--dim);margin-bottom:2px;text-transform:uppercase;letter-spacing:.5px}

/* â”€â”€ ERROR SPOTLIGHT â”€â”€ */
.error-spotlight{margin-top:20px}
.error-card{background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.3);border-radius:14px;padding:20px;margin-bottom:12px;animation:errorGlow 3s infinite;position:relative;overflow:hidden}
.error-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--red)}
@keyframes errorGlow{0%,100%{box-shadow:0 0 20px rgba(239,68,68,.1)}50%{box-shadow:0 0 30px rgba(239,68,68,.25)}}
.error-header{display:flex;align-items:center;gap:10px;margin-bottom:8px;font-weight:700;color:var(--red)}
.error-desc{color:var(--text);font-size:.95rem;margin-bottom:6px}
.error-explain{color:var(--muted);font-size:.85rem;padding:10px;background:rgba(239,68,68,.05);border-radius:8px;border-left:3px solid var(--red)}
.error-explain strong{color:var(--orange)}
.error-meta{display:flex;gap:16px;margin-top:10px;font-size:.8rem;color:var(--dim)}

/* â”€â”€ STATS BAR â”€â”€ */
.stats-bar{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:14px;margin:20px 0}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;box-shadow:0 0 20px var(--glow);transition:transform .2s}
.stat-card:hover{transform:translateY(-2px)}
.stat-label{color:var(--muted);font-size:.72rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
.stat-value{font-size:1.8rem;font-weight:800}
.stat-sub{color:var(--dim);font-size:.72rem;margin-top:4px}
.stat-card.has-errors .stat-value{color:var(--red)}
.stat-sparkline{display:flex;align-items:flex-end;gap:2px;height:24px;margin-top:8px}
.stat-sparkline span{flex:1;background:var(--cyan);border-radius:2px;opacity:.6;min-width:3px}

/* â”€â”€ FILTER BAR â”€â”€ */
.filter-bar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:20px 0;padding:16px;background:var(--card);border:1px solid var(--border);border-radius:14px}
.filter-bar select,.filter-bar input{background:var(--bg);border:1px solid var(--border);color:var(--text);padding:8px 14px;border-radius:10px;font-size:.85rem;font-family:inherit;outline:none;transition:border-color .2s}
.filter-bar select:focus,.filter-bar input:focus{border-color:var(--cyan)}
.filter-bar input{flex:1;min-width:180px}
.filter-label{color:var(--muted);font-size:.7rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px}
.time-btn{padding:6px 14px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--muted);font-size:.8rem;font-weight:600;cursor:pointer;transition:all .2s;font-family:inherit}
.time-btn.active{background:var(--blue);color:#fff;border-color:var(--blue)}
.time-btn:hover:not(.active){background:rgba(255,255,255,.05)}

/* â”€â”€ MAIN LAYOUT â”€â”€ */
.main-layout{display:grid;grid-template-columns:1fr 380px;gap:20px;margin:0 0 40px}
@media(max-width:1024px){.main-layout{grid-template-columns:1fr}}

/* â”€â”€ FEED ENTRIES â”€â”€ */
.feed-entry{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px;margin-bottom:10px;animation:slideIn .4s ease-out;transition:transform .15s,box-shadow .15s}
.feed-entry:hover{transform:translateX(4px);box-shadow:0 0 20px var(--glow)}
@keyframes slideIn{from{opacity:0;transform:translateX(-30px)}to{opacity:1;transform:translateX(0)}}
.feed-top{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
.feed-agent{display:flex;align-items:center;gap:8px}
.feed-agent-emoji{font-size:1.3rem}
.feed-agent-name{font-weight:700;font-size:.9rem}
.feed-time{color:var(--dim);font-size:.78rem;white-space:nowrap}
.feed-action{margin:10px 0 8px;font-size:.95rem;color:var(--text);line-height:1.5}
.feed-bottom{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.feed-badge{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:999px;font-size:.75rem;font-weight:600}
.badge-success{background:rgba(34,197,94,.15);color:var(--green);border:1px solid rgba(34,197,94,.25)}
.badge-skipped{background:rgba(234,179,8,.15);color:var(--yellow);border:1px solid rgba(234,179,8,.25)}
.badge-error{background:rgba(239,68,68,.15);color:var(--red);border:1px solid rgba(239,68,68,.25)}
.feed-duration{color:var(--dim);font-size:.78rem}
.feed-contact{color:var(--cyan);font-size:.82rem;font-weight:600}
.feed-assigned{color:var(--purple);font-size:.78rem;font-weight:500}
.feed-expand{background:none;border:none;color:var(--dim);cursor:pointer;font-size:.8rem;margin-left:auto;padding:4px 8px;border-radius:6px;transition:all .2s;font-family:inherit}
.feed-expand:hover{color:var(--text);background:rgba(255,255,255,.05)}
.feed-details{display:none;margin-top:14px;border-top:1px solid var(--border);padding-top:14px}
.feed-details.open{display:block}
.feed-entry.is-error{border-color:rgba(239,68,68,.3)}

/* Details sub-sections */
.detail-steps{margin-bottom:14px}
.detail-steps h4{font-size:.82rem;font-weight:700;color:var(--cyan);margin-bottom:8px}
.detail-step{display:flex;gap:8px;padding:4px 0;font-size:.82rem;color:var(--muted)}
.detail-step .step-num{color:var(--dim);font-weight:700;flex-shrink:0}
.detail-raw{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:12px;font-family:'SF Mono',Monaco,monospace;font-size:.72rem;color:var(--dim);overflow-x:auto;white-space:pre-wrap;word-break:break-all;margin-bottom:14px}

/* â”€â”€ FEEDBACK SECTION â”€â”€ */
.feedback-section{border-top:1px solid var(--border);padding-top:14px;margin-top:14px}
.feedback-section h4{font-size:.82rem;font-weight:700;color:var(--yellow);margin-bottom:8px;display:flex;align-items:center;gap:6px}
.star-rating{display:flex;gap:4px;margin-bottom:8px}
.star-rating .star{font-size:1.4rem;cursor:pointer;color:var(--dim);transition:color .15s}
.star-rating .star.active{color:var(--yellow)}
.star-rating .star:hover{color:var(--yellow)}
.feedback-text{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:10px;border-radius:8px;font-family:inherit;font-size:.85rem;resize:vertical;min-height:60px}
.feedback-text:focus{outline:none;border-color:var(--cyan)}
.feedback-save{margin-top:8px;padding:8px 20px;background:var(--blue);color:#fff;border:none;border-radius:8px;font-weight:700;font-size:.82rem;cursor:pointer;transition:all .2s;font-family:inherit}
.feedback-save:hover{background:var(--cyan)}
.feedback-existing{background:rgba(234,179,8,.08);border:1px solid rgba(234,179,8,.2);border-radius:8px;padding:12px;margin-top:8px;font-size:.82rem}
.feedback-existing .fe-stars{color:var(--yellow);margin-bottom:4px}
.feedback-existing .fe-comment{color:var(--muted)}

/* â”€â”€ TOAST â”€â”€ */
.toast{position:fixed;bottom:30px;right:30px;background:var(--green);color:#fff;padding:14px 24px;border-radius:12px;font-weight:700;font-size:.9rem;z-index:999;transform:translateY(100px);opacity:0;transition:all .3s}
.toast.show{transform:translateY(0);opacity:1}

/* â”€â”€ SIDEBAR: SCOREBOARD â”€â”€ */
.scoreboard{position:sticky;top:100px}
.scoreboard-title{font-size:1.1rem;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.sb-agent{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:10px;transition:transform .15s}
.sb-agent:hover{transform:translateY(-1px)}
.sb-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.sb-name{font-weight:700;font-size:.85rem;display:flex;align-items:center;gap:6px}
.sb-count{color:var(--muted);font-size:.78rem}
.sb-bar-bg{height:6px;background:rgba(255,255,255,.06);border-radius:3px;overflow:hidden;margin-bottom:6px}
.sb-bar{height:100%;border-radius:3px;transition:width .6s ease}
.sb-stats{display:flex;gap:14px;font-size:.72rem;color:var(--dim)}
.sb-stats span{display:flex;align-items:center;gap:3px}

/* â”€â”€ FEEDBACK SUMMARY â”€â”€ */
.feedback-summary{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:28px;margin:40px 0}
.feedback-summary h2{font-size:1.3rem;font-weight:800;margin-bottom:16px;display:flex;align-items:center;gap:10px}
.fs-entry{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:10px}
.fs-entry .fs-agent{font-size:.82rem;color:var(--cyan);font-weight:600}
.fs-entry .fs-action{font-size:.85rem;margin:4px 0}
.fs-entry .fs-stars{color:var(--yellow);font-size:.9rem}
.fs-entry .fs-comment{color:var(--muted);font-size:.82rem;margin-top:4px;font-style:italic}
.fs-empty{color:var(--dim);font-size:.9rem;text-align:center;padding:20px}
.export-btn{margin-top:16px;padding:10px 24px;background:var(--purple);color:#fff;border:none;border-radius:10px;font-weight:700;font-size:.85rem;cursor:pointer;transition:all .2s;font-family:inherit}
.export-btn:hover{background:var(--pink)}

/* â”€â”€ PRINT â”€â”€ */
@media print{
.header,.filter-bar,.feed-expand,.nav-links,.live-badge,.feedback-save,.export-btn,.star-rating,.feedback-text{display:none!important}
.feed-details{display:block!important}
.main-layout{grid-template-columns:1fr}
.feed-entry{break-inside:avoid;page-break-inside:avoid;border:1px solid #ccc}
body{background:#fff;color:#000}
.stat-card,.sb-agent,.feed-entry,.filter-bar,.error-card,.how-card,.trigger-row,.feedback-summary,.fs-entry{background:#fff;border-color:#ddd;color:#000;box-shadow:none}
.stat-label,.feed-time,.sb-stats,.feed-duration,.error-meta,.section-desc,.how-card p,.trig-output,.detail-raw{color:#666}
}

/* â”€â”€ MOBILE â”€â”€ */
@media(max-width:640px){
.header-title{font-size:1.2rem}
.stats-bar{grid-template-columns:repeat(2,1fr);gap:10px}
.stat-value{font-size:1.4rem}
.stat-card{padding:14px}
.filter-bar{flex-direction:column}
.feed-entry{padding:14px}
.main-layout{gap:14px}
.how-grid{grid-template-columns:1fr}
.trigger-row{flex-wrap:wrap;gap:8px}
.section-title{font-size:1.2rem}
.example-cards{grid-template-columns:1fr}
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â• HEADER â•â•â•â•â•â•â• -->
<div class="header">
<div class="container">
<div class="header-inner">
<div class="header-left">
<div>
<div class="header-title">ğŸ”« Gunner Audit Log</div>
<div class="header-sub">See everything the system does, in real-time. Every lead, every action, every result.</div>
</div>
<div class="live-badge"><span class="live-dot"></span> LIVE</div>
</div>
<div class="nav-links">
<a href="/dashboard">â† Dashboard</a>
<a href="/dashboard/controls">Control Room</a>
<a class="current" href="/dashboard/audit">Audit Log</a>
</div>
</div>
</div>
</div>

<div class="container">

<!-- â•â•â•â•â•â•â• HOW IT WORKS â•â•â•â•â•â•â• -->
<div class="section">
<div class="section-title">ğŸ“– How This Works</div>
<div class="section-desc">New to this page? Here's what you need to know.</div>
</div>

<div class="how-grid">
<div class="how-card hc1">
<h3>ğŸ¤– What is this?</h3>
<p>Gunner watches every lead that comes into GHL and takes action automatically â€” scoring, tagging, texting, creating tasks, and more. <strong>This page shows you exactly what it did, why, and when.</strong></p>
</div>
<div class="how-card hc2">
<h3>ğŸ›¡ï¸ Why it matters</h3>
<p>No lead falls through the cracks. Every single action is logged. If something breaks, <strong>you'll see it here before it affects a deal.</strong> Think of this as your security camera for the entire sales pipeline.</p>
</div>
<div class="how-card hc3">
<h3>ğŸ‘€ What you'll see</h3>
<p>Each card below is one action Gunner took. It tells you <strong>who</strong> it acted on, <strong>what</strong> it did, and <strong>whether it worked</strong>. You can expand any card for the full story, and leave feedback for Corey.</p>
</div>
</div>

<!-- Example cards with annotations -->
<div class="section-desc" style="margin-top:0"><strong>Here's what the entries look like:</strong></div>
<div class="example-cards">
<div class="ex-card">
<span class="ex-label">Success</span>
<div class="ex-agent">ğŸ¯ Lead Scorer</div>
<div class="ex-action">âœ… Scored Marcus Thompson as <strong>HOT</strong> (85 points) â€” property at 1847 Shelby Ave</div>
<div class="ex-meta"><span class="ex-badge" style="background:rgba(34,197,94,.15);color:var(--green)">âœ… success</span><span>took 1.2s</span><span style="color:var(--cyan)">Marcus Thompson</span></div>
</div>
<div class="ex-card">
<span class="ex-label">Task Created</span>
<div class="ex-agent">âœ… Lead Task Creator</div>
<div class="ex-action">âœ… Created task for Chris: <strong>Call this lead within 15 minutes</strong> â€” high motivation seller</div>
<div class="ex-meta"><span class="ex-badge" style="background:rgba(34,197,94,.15);color:var(--green)">âœ… success</span><span>took 0.8s</span><span style="color:var(--purple)">â†’ Chris Segura</span></div>
</div>
<div class="ex-card">
<span class="ex-label">Error</span>
<div class="ex-agent">ğŸ“± Initial Outreach</div>
<div class="ex-action">âŒ Failed to send SMS to Jerome â€” <strong>outside send window</strong> (will retry at 9 AM)</div>
<div class="ex-meta"><span class="ex-badge" style="background:rgba(239,68,68,.15);color:var(--red)">âŒ error</span><span style="color:var(--orange)">TCPA compliance</span></div>
</div>
</div>

<!-- â•â•â•â•â•â•â• TRIGGER MAP â•â•â•â•â•â•â• -->
<div class="section">
<div class="section-title">ğŸ—ºï¸ Trigger Map â€” What Fires What</div>
<div class="section-desc">Every trigger in the system, what agents it activates, and what the output is. This is the full automation flow.</div>
</div>

<div class="trigger-map" id="triggerMap"></div>

<!-- â•â•â•â•â•â•â• ERROR SPOTLIGHT â•â•â•â•â•â•â• -->
<div class="error-spotlight" id="errorSpotlight"></div>

<!-- â•â•â•â•â•â•â• STATS DASHBOARD â•â•â•â•â•â•â• -->
<div class="stats-bar" id="statsBar">
<div class="stat-card">
<div class="stat-label">Actions Today</div>
<div class="stat-value" id="statActions">â€”</div>
<div class="stat-sparkline" id="sparkActions"></div>
</div>
<div class="stat-card">
<div class="stat-label">Leads Processed</div>
<div class="stat-value" id="statLeads">â€”</div>
<div class="stat-sub">unique contacts</div>
</div>
<div class="stat-card">
<div class="stat-label">Agents Active</div>
<div class="stat-value" id="statAgents">â€”</div>
<div class="stat-sub" id="statAgentsSub">of 32 total</div>
</div>
<div class="stat-card">
<div class="stat-label">Bots Active</div>
<div class="stat-value" id="statBots">â€”</div>
<div class="stat-sub">of 9 total</div>
</div>
<div class="stat-card" id="statErrorCard">
<div class="stat-label">Errors</div>
<div class="stat-value" id="statErrors">â€”</div>
<div class="stat-sub">see details above â†‘</div>
</div>
<div class="stat-card">
<div class="stat-label">Avg Response</div>
<div class="stat-value" id="statAvg">â€”</div>
<div class="stat-sub">seconds per action</div>
</div>
</div>

<!-- â•â•â•â•â•â•â• FILTER BAR â•â•â•â•â•â•â• -->
<div class="filter-bar">
<div>
<div class="filter-label">Agent</div>
<select id="filterAgent"><option value="">All Agents</option></select>
</div>
<div>
<div class="filter-label">Result</div>
<select id="filterResult">
<option value="">All</option>
<option value="success">âœ… Success</option>
<option value="skipped">â­ï¸ Skipped</option>
<option value="error">âŒ Error</option>
</select>
</div>
<div>
<div class="filter-label">Time Range</div>
<div style="display:flex;gap:4px">
<button class="time-btn" data-range="1">1h</button>
<button class="time-btn" data-range="4">4h</button>
<button class="time-btn active" data-range="12">12h</button>
<button class="time-btn" data-range="24">24h</button>
<button class="time-btn" data-range="168">7d</button>
</div>
</div>
<div style="flex:1;min-width:180px">
<div class="filter-label">Search Contact</div>
<input type="text" id="filterSearch" placeholder="Search by contact name...">
</div>
</div>

<!-- â•â•â•â•â•â•â• MAIN LAYOUT: FEED + SCOREBOARD â•â•â•â•â•â•â• -->
<div class="main-layout">
<div id="feedContainer"></div>
<div>
<div class="scoreboard" id="scoreboard">
<div class="scoreboard-title">ğŸ“Š Agent Scoreboard</div>
<div id="sbList"></div>
</div>
</div>
</div>

<!-- â•â•â•â•â•â•â• FEEDBACK SUMMARY â•â•â•â•â•â•â• -->
<div class="feedback-summary" id="feedbackSummary">
<h2>ğŸ“‹ Feedback Summary</h2>
<div class="section-desc" style="margin-bottom:16px">All entries with feedback from the team. Corey reviews these.</div>
<div id="fsList"></div>
<button class="export-btn" onclick="exportFeedback()">ğŸ“‹ Copy All Feedback to Clipboard</button>
</div>

</div><!-- /container -->

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// â”€â”€ AGENTS â”€â”€
const AGENTS = {
'new-lead-pipeline':{emoji:'ğŸ”',name:'New Lead Pipeline'},
'lead-scorer':{emoji:'ğŸ¯',name:'Lead Scorer'},
'lead-tagger':{emoji:'ğŸ·ï¸',name:'Lead Tagger'},
'lead-noter':{emoji:'ğŸ“',name:'Lead Noter'},
'lead-task-creator':{emoji:'âœ…',name:'Lead Task Creator'},
'initial-outreach':{emoji:'ğŸ“±',name:'Initial Outreach'},
'outbound-manager':{emoji:'ğŸ“¤',name:'Outbound Manager'},
'response-agent':{emoji:'ğŸ’¬',name:'Response Agent'},
'lm-assistant':{emoji:'ğŸ“',name:'LM Assistant'},
'call-coaching':{emoji:'ğŸ“',name:'Call Coaching'},
'working-drip':{emoji:'ğŸ’§',name:'Working Drip'},
'ghosted-agent':{emoji:'ğŸ‘»',name:'Ghosted Agent'},
'bucket-reeval':{emoji:'ğŸ”„',name:'Bucket Re-eval'},
'apt-prep':{emoji:'ğŸ“…',name:'Appointment Prep'},
'apt-reminder-poller':{emoji:'â°',name:'Apt Reminder'},
'am-assistant':{emoji:'ğŸ¤',name:'AM Assistant'},
'follow-up-organizer':{emoji:'ğŸ“Š',name:'Follow-Up Organizer'},
'follow-up-messenger':{emoji:'ğŸ’Œ',name:'Follow-Up Messenger'},
'follow-up-closer':{emoji:'ğŸ”¥',name:'Follow-Up Closer'},
'offer-chase':{emoji:'ğŸ’°',name:'Offer Chase'},
'offer-reply':{emoji:'ğŸ“©',name:'Offer Reply'},
'tc-packager':{emoji:'ğŸ“¦',name:'TC Packager'},
'dispo-packager':{emoji:'ğŸ“¦',name:'Dispo Packager'},
'contract-bot':{emoji:'ğŸ—ï¸',name:'Contract Bot'},
'uc-monitor':{emoji:'ğŸ“¡',name:'UC Monitor'},
'post-close-bot':{emoji:'ğŸ‰',name:'Post-Close Bot'},
'accountability-agent':{emoji:'âš–ï¸',name:'Accountability'},
'reality-check':{emoji:'ğŸ”¬',name:'Reality Check'},
'callback-capture':{emoji:'ğŸ“²',name:'Callback Capture'},
'stage-change-router':{emoji:'ğŸ”€',name:'Stage Change Router'},
'already-sold-agent':{emoji:'ğŸ ',name:'Already Sold Agent'},
'reality-check-poller':{emoji:'ğŸ”¬',name:'Reality Check Poller'}
};

const TEAM = [
{name:'Kyle Barks',short:'Kyle',role:'AM'},
{name:'Chris Segura',short:'Chris',role:'LM-Nashville'},
{name:'Daniel Lozano',short:'Daniel',role:'LM-Columbia'},
{name:'Esteban Leiva',short:'Esteban',role:'Dispo'},
{name:'Jessica Guzman',short:'Jessica',role:'Data'}
];

const CONTACTS = [
'Marcus Thompson','Tiffany Reynolds','Robert Williams','DeShawn Carter','Patricia Gomez',
'James Mitchell','Angela Foster','David Chen','Brenda Washington','Kevin O\'Brien',
'Sandra Phillips','Tyrone Baker','Lisa Hernandez','William Park','Denise Thompson',
'Jerome Davis','Carla Nguyen','Michael Scott','Tamika Brown','Russell Adams',
'LaShonda Green','Anthony Ruiz','Teresa Kim','Brandon Wright','Monica Castillo',
'Earl Jefferson','Natasha Petrov','Derek Hawkins','Carmen Reyes','Vincent Howard'
];
const ADDRESSES = [
'1423 Shelby Ave','308 S 11th St','742 Boscobel St','215 Ewing Dr','1809 5th Ave N',
'3312 Clarksville Pike','604 Creek Trail Dr, Goodlettsville','118 Creekside Ct, Columbia',
'2240 Murfreesboro Pike','917 Drummond Dr','445 Harding Pl','1620 Eastland Ave',
'3009 Linden Ave','824 Meridian St','201 Edgehill Ave, Columbia','507 Weakley Ave, Columbia',
'1105 Burchwood Ave','2814 Torbett St','4409 Gallatin Pike','1517 Fatherland St',
'819 Benton Ave','3201 West End Ave','2126 Elliott Ave','711 S 12th St, Nashville'
];

function rand(a,b){return Math.floor(Math.random()*(b-a+1))+a}
function pick(arr){return arr[rand(0,arr.length-1)]}
function pickTeam(){return pick(TEAM)}
const NOW = Date.now();
function ago(ms){
const s=Math.floor(ms/1000),m=Math.floor(s/60),h=Math.floor(m/60);
if(s<60) return 'Just now';
if(m<60) return m+' min ago';
if(h<24) return h+'h '+Math.floor(m%60)+'m ago';
return Math.floor(h/24)+'d ago';
}

// â”€â”€ TRIGGER MAP DATA â”€â”€
const TRIGGERS = [
{phase:'intake',color:'var(--cyan)',event:'ğŸ†• New Lead Enters Pipeline',sub:'Stage: New Lead',agents:['new-lead-pipeline','lead-scorer','lead-tagger','lead-noter','lead-task-creator','initial-outreach'],output:'Lead scored, tagged, noted, task created for LM, first text sent within 3 min'},
{phase:'working',color:'var(--blue)',event:'ğŸŸ¡ Lead Moves to Warm',sub:'Stage: Warm',agents:['lm-assistant','working-drip'],output:'LM briefed with call prep, drip sequence activated (24 touches over 104 days)'},
{phase:'working',color:'var(--blue)',event:'ğŸ”¥ Lead Moves to Hot',sub:'Stage: Hot',agents:['lm-assistant','working-drip'],output:'Priority brief for LM, accelerated drip sequence'},
{phase:'apt',color:'var(--purple)',event:'ğŸ“… Pending Appointment',sub:'Stage: Pending Apt',agents:['apt-prep'],output:'Appointment package prepped â€” comps, ARV, seller brief'},
{phase:'apt',color:'var(--purple)',event:'ğŸ  Walkthrough Appointment',sub:'Stage: Walkthrough Apt',agents:['apt-prep','am-assistant'],output:'Kyle briefed with comps, ARV range, seller motivation. Reminders sent.'},
{phase:'apt',color:'var(--purple)',event:'ğŸ’¼ Offer Appointment',sub:'Stage: Offer Apt',agents:['apt-prep','am-assistant'],output:'Offer range calculated, seller profile prepared for Kyle'},
{phase:'offer',color:'var(--orange)',event:'ğŸ’° Made Offer',sub:'Stage: Made Offer',agents:['offer-chase'],output:'Follow-up sequence: Day 3, Day 7, Day 14 reminders to seller'},
{phase:'close',color:'var(--green)',event:'ğŸ“ Under Contract',sub:'Stage: Under Contract',agents:['contract-bot','uc-monitor','tc-packager','dispo-packager'],output:'Confirmation SMS, AM task (1hr), TC package, dispo package to 47 buyers'},
{phase:'close',color:'var(--green)',event:'ğŸ‰ Purchased',sub:'Stage: Purchased',agents:['post-close-bot'],output:'Thank you text (24h), Google review request (48h), referral ask (7d)'},
{phase:'followup',color:'var(--yellow)',event:'ğŸ‘» Lead Goes Silent',sub:'Stage: Ghosted',agents:['ghosted-agent'],output:'Re-engagement sequence: breakup text, new comp email, voicemail drop'},
{phase:'followup',color:'var(--yellow)',event:'ğŸ“Š Follow-Up Bucket',sub:'1mo / 4mo / 1yr',agents:['follow-up-organizer','follow-up-messenger'],output:'Queue organized by priority, scheduled touches at the right intervals'},
{phase:'comms',color:'var(--pink)',event:'ğŸ’¬ Inbound SMS',sub:'Lead texts in',agents:['response-agent'],output:'AI-powered reply within seconds, escalation if needed'},
{phase:'comms',color:'var(--pink)',event:'ğŸ“ Inbound Call',sub:'Lead calls in',agents:['callback-capture'],output:'Call logged, callback task created, LM notified immediately'},
];

function renderTriggerMap(){
const el=document.getElementById('triggerMap');
const phaseMap={intake:'phase-intake',working:'phase-working',apt:'phase-apt',offer:'phase-offer',close:'phase-close',followup:'phase-followup',comms:'phase-comms'};
el.innerHTML=TRIGGERS.map(t=>{
const agentTags=t.agents.map(a=>{const ag=AGENTS[a];return ag?`<span class="trig-agent">${ag.emoji} ${ag.name}</span>`:`<span class="trig-agent">${a}</span>`}).join('');
return `<div class="trigger-row ${phaseMap[t.phase]}">
<div class="trig-event"><div class="trig-icon">${t.event.split(' ')[0]}</div><div class="trig-label">${t.event.replace(/^[^\s]+\s/,'')}</div><div class="trig-sub">${t.sub}</div></div>
<span class="trig-arrow">â†’</span>
<div class="trig-agents">${agentTags}</div>
<span class="trig-arrow">â†’</span>
<div class="trig-output"><strong>Output</strong>${t.output}</div>
</div>`}).join('');
}

// â”€â”€ GENERATE MOCK DATA (45+ entries) â”€â”€
function generateEntries(){
const entries = [];

// Marcus Thompson's full journey (5 steps)
const marcusTime = rand(600000,1800000);
const marcusAddr = '1847 Shelby Ave';
[
{agent:'new-lead-pipeline',action:'New lead received: Marcus Thompson at '+marcusAddr+' â€” PPL source (Leadzolo)',offset:0,team:TEAM[1]},
{agent:'lead-scorer',action:'Scored Marcus Thompson as HOT (85 points) â€” motivated seller, probate property at '+marcusAddr,offset:12000,team:TEAM[1]},
{agent:'lead-tagger',action:'Tagged Marcus Thompson as "Probate" and "Hot Lead" â€” property at '+marcusAddr,offset:18000,team:TEAM[1]},
{agent:'lead-noter',action:'Added note to Marcus Thompson: "Inherited property from grandmother. Wants to sell ASAP â€” behind on taxes 2 years. Property needs full rehab."',offset:25000,team:TEAM[1]},
{agent:'lead-task-creator',action:'Created task for Chris Segura: Call Marcus Thompson within 15 minutes â€” HOT lead, probate, motivated',offset:30000,team:TEAM[1]},
{agent:'initial-outreach',action:'Sent first text to Marcus at 10:23 AM â€” personalized based on probate situation. "Hi Marcus, this is Chris with New Again Houses..."',offset:35000,team:TEAM[1]},
].forEach((e,i)=>{
entries.push({
id:'evt-m'+i,timestamp:NOW-marcusTime-e.offset,agent:e.agent,
action:e.action,result:'success',duration:parseFloat((Math.random()*2+0.3).toFixed(1)),
contact:'Marcus Thompson',assignedTo:e.team,
steps:['Received webhook from GHL','Validated contact data','Executed agent logic','Updated GHL via bot','Logged result'],
raw:{eventId:'evt-m'+i,agentId:e.agent,contactName:'Marcus Thompson',address:marcusAddr,result:'success'}
});
});

// More realistic entries
const templates = [
{agent:'lead-scorer',gen:(c,a)=>{const s=rand(20,98);const tier=s>=75?'HOT':s>=50?'WARM':'COLD';return{action:`Scored ${c} as ${tier} (${s} points) â€” property at ${a}`,steps:['Pulled contact data','Analyzed 5 scoring factors','Timeline: '+(s>70?'PASS':'NEEDS INFO'),'Motivation: '+(s>60?'PASS':'LOW'),'Calculated final score: '+s]}},team:()=>pickTeam()},
{agent:'lead-tagger',gen:(c,a)=>({action:`Tagged ${c} as "${pick(['Motivated Seller','Absentee Owner','Pre-Foreclosure','Probate','Vacant','Tired Landlord'])}" â€” ${a}`,steps:['Evaluated lead data','Matched tag rules','Applied tag via Tag Bot','Confirmed in GHL']}),team:()=>pickTeam()},
{agent:'lead-noter',gen:(c,a)=>({action:`Added note to ${c}: "${pick(['Seller mentioned moving deadline is end of March','Property inherited 6 months ago, never lived there','Behind on mortgage 3 months, wants quick close','Relocating to Texas for work, needs to sell fast','Tenant issues â€” wants to offload property ASAP'])}"`,steps:['Generated AI note from lead data','Formatted for GHL','Posted via Note Bot']}),team:()=>pickTeam()},
{agent:'lead-task-creator',gen:(c,a)=>{const tm=pickTeam();return{action:`Created task for ${tm.name}: Call ${c} within ${pick(['15 minutes','30 minutes','1 hour'])} â€” property at ${a}`,steps:['Determined assignee: '+tm.name,'Set deadline','Created task via Task Bot','Notification sent'],assignedTo:tm}},team:null},
{agent:'initial-outreach',gen:(c,a)=>{const h=rand(9,17);const m=rand(0,59);return{action:`Sent first text to ${c.split(' ')[0]} at ${h>12?h-12:h}:${String(m).padStart(2,'0')} ${h>=12?'PM':'AM'} â€” personalized based on ${pick(['motivation','property condition','lead source','timeline urgency'])}`,steps:['Generated personalized SMS via Gemini','Checked send window (9AM-6PM CST)','Sent via SMS Bot','Confirmed delivery']}},team:()=>pickTeam()},
{agent:'response-agent',gen:(c,a)=>({action:`Replied to inbound text from ${c.split(' ')[0]}: "${pick(['"Thanks for reaching out! When works best for a quick call?"','"Got it â€” I\'ll have someone call you shortly."','"Totally understand. What timeline are you thinking?"','"Great question â€” let me get Kyle on the phone with you."'])}"`,steps:['Received inbound SMS webhook','Analyzed message intent','Generated AI response','Sent reply via SMS Bot']}),team:()=>pickTeam()},
{agent:'working-drip',gen:(c,a)=>{const touch=rand(1,24);return{action:`Sent drip touch #${touch}/24 to ${c} â€” Day ${touch*4} of sequence. "${pick(['Just checking in on the property...','Wanted to see if anything has changed...','Still interested in making you an offer...','Market update: similar homes in your area sold recently...'])}"`,steps:['Checked drip_active=true','Verified send window','Generated message for touch #'+touch,'Sent via SMS Bot']}},team:()=>pickTeam()},
{agent:'ghosted-agent',gen:(c,a)=>({action:`Re-engaged ${c} after ${rand(14,30)} days of silence â€” sent ${pick(['breakup text: "No hard feelings if you\'ve decided not to sell..."','new comp email with recent sales in their area','voicemail drop with personalized message'])}`,steps:['Detected 14+ days no contact','Checked ghosted tag','Selected re-engagement strategy','Sent outreach','Moved to Ghosted stage']}),team:()=>pickTeam()},
{agent:'apt-prep',gen:(c,a)=>{const arv=rand(180,420);return{action:`Prepped appointment package for ${c} at ${a} â€” ARV estimated at $${arv}K, ${rand(2,4)} comps pulled, seller brief ready for Kyle`,steps:['Pulled property data','Found '+rand(3,6)+' comparable sales','Estimated ARV: $'+arv+'K','Estimated repairs: $'+rand(15,80)+'K','Created appointment brief','Assigned to Kyle Barks']}},team:()=>TEAM[0]},
{agent:'am-assistant',gen:(c,a)=>{const arv=rand(200,380);return{action:`Briefed Kyle Barks on ${c}: offer range $${rand(120,arv-30)}K - $${arv}K based on ${rand(3,5)} comps. ${pick(['Seller motivated â€” probate','Seller needs to close before April','Property has title issues, proceed carefully','Strong deal â€” below 70% ARV minus repairs'])}`,steps:['Compiled deal analysis','Calculated offer range','Assessed seller motivation','Prepared brief for AM','Notified Kyle']}},team:()=>TEAM[0]},
{agent:'offer-chase',gen:(c,a)=>({action:`Following up on pending offer to ${c} â€” sent ${pick(['Day 3 reminder: "Just wanted to check if you\'ve had a chance to review..."','Day 7 follow-up: "Wanted to circle back on our offer..."','Day 14 final push: "Our offer is still on the table..."'])}`,steps:['Checked offer_chase timeline','Selected appropriate follow-up','Generated message','Sent via SMS Bot']}),team:()=>TEAM[0]},
{agent:'contract-bot',gen:(c,a)=>({action:`Under contract: ${c} at ${a} â€” confirmation SMS sent, task created for Kyle (1hr deadline), TC and Dispo packages initiated`,steps:['Received UC stage change','Sent confirmation SMS to seller','Created AM task: Get details to TC/Dispo','Fired TC Packager','Fired Dispo Packager']}),team:()=>TEAM[0]},
{agent:'uc-monitor',gen:(c,a)=>({action:`Checked in with ${c} (under contract) â€” seller ${pick(['responded positively, closing on track','asked about closing timeline, created task for TC','has been quiet 5 days, sent proactive check-in','expressed concern â€” URGENT task created for Kyle'])}`,steps:['Ran 30-min monitor check','Analyzed recent messages','Determined action needed','Executed response']}),team:()=>TEAM[0]},
{agent:'post-close-bot',gen:(c,a)=>({action:`Post-close: Sent ${pick(['thank you text to '+c+' â€” "It was great working with you!"','Google review request to '+c+' â€” personalized link included','soft referral ask to '+c+' â€” "Know anyone else thinking of selling?"'])}`,steps:['Checked post-close sequence timing','Generated personalized message','Sent via SMS Bot']}),team:()=>TEAM[0]},
{agent:'follow-up-organizer',gen:(c,a)=>({action:`Organized follow-up queue: ${rand(8,24)} leads ready for outreach today â€” prioritized by ${pick(['recency of last contact','lead score','time in bucket','seller responsiveness'])}`,steps:['Scanned all follow-up buckets','Ranked by priority score','Created today\'s queue','Notified Follow-Up Messenger']}),team:()=>pickTeam()},
{agent:'dispo-packager',gen:(c,a)=>{const arv=rand(200,400);return{action:`Created dispo package for ${a} â€” ${rand(2,4)} bed/${rand(1,3)} bath, ARV $${arv}K, asking $${rand(Math.round(arv*.55),Math.round(arv*.7))}K, sent to ${rand(35,60)} buyers`,steps:['Compiled property details','Calculated wholesale spread','Generated buyer-facing package','Blasted to buyer list']}},team:()=>TEAM[3]},
{agent:'accountability-agent',gen:(c,a)=>{const tm=pickTeam();return{action:`Daily check: ${tm.name} has ${rand(2,6)} overdue tasks â€” sent ${pick(['yellow flag (15 min overdue)','orange alert to Jessica','ğŸ”´ RED escalation to Corey â€” 60+ min overdue'])}`,steps:['Scanned all open tasks','Found overdue items','Determined escalation tier','Sent notification'],assignedTo:tm}},team:null},
{agent:'callback-capture',gen:(c,a)=>({action:`Inbound call from ${c} captured â€” callback task created for ${pickTeam().name}, call logged in GHL`,steps:['Received inbound call webhook','Matched to existing contact','Created callback task','Notified assigned LM']}),team:()=>pickTeam()},
{agent:'reality-check',gen:(c,a)=>({action:`Verified data for ${c}: ${pick(['phone number confirmed active via skip trace','address matches county records â€” owner verified','found duplicate opportunity â€” flagged for merge','pipeline stalled 48+ hours â€” flagged for review'])}`,steps:['Ran verification checks','Cross-referenced external data','Updated contact record','Flagged issues if found']}),team:()=>pickTeam()},
{agent:'call-coaching',gen:(c,a)=>({action:`Graded call with ${c}: ${pick(['A â€” Excellent rapport, strong discovery, clean close','B+ â€” Good needs assessment, missed urgency signal at 4:20','B â€” Solid objection handling, needs stronger close','C+ â€” Rushed discovery, didn\'t ask about timeline'])} â€” coaching notes added to GHL`,steps:['Received call recording from Gunner','Transcribed and analyzed','Graded on 6 factors','Posted coaching note to GHL']}),team:()=>pickTeam()},
];

// Generate 38 more varied entries
for(let i=0;i<38;i++){
const t=pick(templates);
const contact=pick(CONTACTS);
const addr=pick(ADDRESSES);
const msAgo=rand(60000,10*3600000);
const gen=t.gen(contact,addr);
const tm=gen.assignedTo || (t.team?t.team():pickTeam());
const duration=(Math.random()*3+0.2).toFixed(1);
const result = Math.random()>.92?'skipped':'success';
entries.push({
id:'evt-'+rand(10000,99999),timestamp:NOW-msAgo,agent:t.agent,
action:gen.action,result,duration:parseFloat(duration),
contact,assignedTo:tm,steps:gen.steps||[],
raw:{eventId:'evt-'+rand(10000,99999),agentId:t.agent,contactName:contact,address:addr,durationMs:Math.round(duration*1000),result,assignedTo:tm.name}
});
}

// Error entries with detailed explanations
const errors = [
{agent:'initial-outreach',action:'Failed to send SMS to Jerome Davis â€” outside allowed send window (9:47 PM CST, limit is 6:00 PM)',contact:'Jerome Davis',
explain:'<strong>What this means for you:</strong> Text messages can only be sent between 9 AM and 6 PM CST to comply with TCPA regulations. Jerome\'s first text will automatically send tomorrow at 9:00 AM. No action needed â€” the system handles this.',
steps:['Received new lead webhook','Generated personalized SMS','Checked send window: 9:47 PM > 6:00 PM limit','BLOCKED â€” queued for 9:00 AM tomorrow'],assignedTo:TEAM[1]},
{agent:'lead-scorer',action:'Failed to score Patricia Gomez â€” contact has no phone number on file',contact:'Patricia Gomez',
explain:'<strong>What this means for you:</strong> The scoring system needs a phone number to verify the lead. Patricia was imported without one. <strong>Action needed:</strong> Someone on the team should manually add her phone number in GHL, then the scorer will automatically re-run.',
steps:['Received scoring request','Pulled contact data','Missing required field: phone','Scoring aborted â€” manual intervention needed'],assignedTo:TEAM[4]},
{agent:'response-agent',action:'Failed to reply to Robert Williams â€” GHL API returned timeout after 30 seconds',contact:'Robert Williams',
explain:'<strong>What this means for you:</strong> GoHighLevel\'s servers were slow and didn\'t respond in time. The system will automatically retry in 5 minutes. If Robert texted something urgent, a team member may want to reply manually in GHL just in case.',
steps:['Received inbound SMS webhook','Generated AI reply','Attempted send via SMS Bot','GHL API timeout (30s)','Scheduled retry in 5 minutes'],assignedTo:TEAM[1]},
{agent:'accountability-agent',action:'Failed to send escalation for overdue tasks â€” notification service returned error 503',contact:'Team',
explain:'<strong>What this means for you:</strong> The accountability system tried to flag overdue tasks but the notification couldn\'t be delivered. The tasks are still overdue â€” check GHL manually today. The system will retry on the next cycle (30 min).',
steps:['Detected 4 overdue tasks','Attempted to send notification','Service returned 503','Scheduled retry in 30 minutes'],assignedTo:TEAM[4]},
];
errors.forEach((e,i)=>{
entries.push({
id:'evt-err-'+i,timestamp:NOW-rand(300000,7200000),agent:e.agent,
action:e.action,result:'error',duration:null,contact:e.contact,
explain:e.explain,steps:e.steps,assignedTo:e.assignedTo,
raw:{eventId:'evt-err-'+i,agentId:e.agent,contactName:e.contact,error:e.action}
});
});

entries.sort((a,b)=>b.timestamp-a.timestamp);
return entries;
}

let allEntries = generateEntries();
let selectedRange = 12;

// Try to load real audit data from the API
(async function loadRealAudit() {
  try {
    const res = await fetch('/api/audit');
    const data = await res.json();
    if (Array.isArray(data) && data.length > 0) {
      allEntries = data.map(e => ({
        id: e.id || e.eventId || ('evt-' + Math.random().toString(36).slice(2,7)),
        timestamp: e.timestamp ? new Date(e.timestamp).getTime() : Date.now(),
        agent: e.agentId || e.agent || 'unknown',
        action: e.action || e.message || JSON.stringify(e),
        result: e.result || (e.error ? 'error' : 'success'),
        duration: e.durationMs ? e.durationMs / 1000 : null,
        contact: e.contactName || e.contact || '',
        assignedTo: e.assignedTo ? { name: e.assignedTo, role: '' } : null,
        steps: e.steps || [],
        raw: e
      }));
      allEntries.sort((a,b) => b.timestamp - a.timestamp);
      renderAll();
    }
  } catch (e) { console.log('Using mock audit data (API unavailable)', e); }
})();

// Populate agent filter
const agentSelect = document.getElementById('filterAgent');
const usedAgents = [...new Set(allEntries.map(e=>e.agent))].sort();
usedAgents.forEach(a=>{
const ag=AGENTS[a];if(!ag)return;
const o=document.createElement('option');o.value=a;o.textContent=ag.emoji+' '+ag.name;agentSelect.appendChild(o);
});

// â”€â”€ FEEDBACK STORAGE â”€â”€
function getFeedback(id){try{return JSON.parse(localStorage.getItem('gunner-fb-'+id))}catch(e){return null}}
function saveFeedback(id,rating,comment){localStorage.setItem('gunner-fb-'+id,JSON.stringify({rating,comment,ts:Date.now()}))}
function getAllFeedback(){const fb=[];for(let i=0;i<localStorage.length;i++){const k=localStorage.key(i);if(k.startsWith('gunner-fb-')){try{const v=JSON.parse(localStorage.getItem(k));v.id=k.replace('gunner-fb-','');fb.push(v)}catch(e){}}}return fb}

function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500)}

// â”€â”€ FILTERS â”€â”€
function getFiltered(){
const fa=document.getElementById('filterAgent').value;
const fr=document.getElementById('filterResult').value;
const fs=document.getElementById('filterSearch').value.toLowerCase();
const cutoff=NOW-selectedRange*3600000;
return allEntries.filter(e=>{
if(e.timestamp<cutoff) return false;
if(fa && e.agent!==fa) return false;
if(fr && e.result!==fr) return false;
if(fs && !(e.contact||'').toLowerCase().includes(fs) && !e.action.toLowerCase().includes(fs)) return false;
return true;
});
}

// â”€â”€ RENDER ERRORS â”€â”€
function renderErrors(entries){
const el=document.getElementById('errorSpotlight');
const errs=entries.filter(e=>e.result==='error');
if(!errs.length){el.innerHTML='';return;}
el.innerHTML='<div class="section"><div class="section-title" style="color:var(--red)">ğŸš¨ Error Spotlight â€” '+errs.length+' Issue'+(errs.length>1?'s':'')+'</div></div>'+
errs.map(e=>{const a=AGENTS[e.agent]||{emoji:'â“',name:e.agent};return`
<div class="error-card">
<div class="error-header">âŒ ${a.emoji} ${a.name}</div>
<div class="error-desc">${e.action}</div>
<div class="error-explain">${e.explain||'An unexpected error occurred. The system will retry automatically.'}</div>
<div class="error-meta"><span>ğŸ• ${ago(NOW-e.timestamp)}</span><span>ğŸ‘¤ ${e.contact||'â€”'}</span>${e.assignedTo?'<span>â†’ '+e.assignedTo.name+'</span>':''}</div>
</div>`}).join('');
}

// â”€â”€ RENDER STATS â”€â”€
function renderStats(entries){
const all=allEntries.filter(e=>e.timestamp>NOW-selectedRange*3600000);
document.getElementById('statActions').textContent=all.length;
const leads=new Set(all.filter(e=>e.contact&&e.contact!=='Team').map(e=>e.contact));
document.getElementById('statLeads').textContent=leads.size;
const activeAgents=new Set(all.map(e=>e.agent));
document.getElementById('statAgents').textContent=activeAgents.size+' / 32';
document.getElementById('statBots').textContent='9 / 9';
const errCount=all.filter(e=>e.result==='error').length;
document.getElementById('statErrors').textContent=errCount;
const card=document.getElementById('statErrorCard');
if(errCount>0)card.classList.add('has-errors');else card.classList.remove('has-errors');
const durations=all.filter(e=>e.duration).map(e=>e.duration);
document.getElementById('statAvg').textContent=durations.length?(durations.reduce((a,b)=>a+b,0)/durations.length).toFixed(1)+'s':'â€”';
const sp=document.getElementById('sparkActions');
const bars=[5,8,12,6,9,14,11,7,13,10,8,15,9,11,7,12];
sp.innerHTML=bars.map(b=>`<span style="height:${Math.round(b/15*100)}%"></span>`).join('');
}

// â”€â”€ RENDER FEED â”€â”€
function renderFeed(entries){
const el=document.getElementById('feedContainer');
if(!entries.length){el.innerHTML='<div style="text-align:center;padding:40px;color:var(--dim)">No entries match your filters.</div>';return;}
el.innerHTML=entries.map((e,i)=>{
const a=AGENTS[e.agent]||{emoji:'â“',name:e.agent};
const badgeCls=e.result==='success'?'badge-success':e.result==='skipped'?'badge-skipped':'badge-error';
const badgeIcon=e.result==='success'?'âœ…':e.result==='skipped'?'â­ï¸':'âŒ';
const fb=getFeedback(e.id);
const stepsHtml=e.steps&&e.steps.length?`<div class="detail-steps"><h4>What happened step by step:</h4>${e.steps.map((s,j)=>`<div class="detail-step"><span class="step-num">${j+1}.</span>${s}</div>`).join('')}</div>`:'';
const fbExistingHtml=fb?`<div class="feedback-existing"><div class="fe-stars">${'â˜…'.repeat(fb.rating)}${'â˜†'.repeat(5-fb.rating)}</div><div class="fe-comment">"${fb.comment}"</div></div>`:'';

return `<div class="feed-entry${e.result==='error'?' is-error':''}" style="animation-delay:${Math.min(i*30,600)}ms">
<div class="feed-top">
<div class="feed-agent"><span class="feed-agent-emoji">${a.emoji}</span><span class="feed-agent-name">${a.name}</span></div>
<span class="feed-time">${ago(NOW-e.timestamp)}</span>
</div>
<div class="feed-action">${e.action}</div>
<div class="feed-bottom">
<span class="feed-badge ${badgeCls}">${badgeIcon} ${e.result}</span>
${e.duration?`<span class="feed-duration">â± ${e.duration}s</span>`:''}
${e.contact?`<span class="feed-contact">ğŸ‘¤ ${e.contact}</span>`:''}
${e.assignedTo?`<span class="feed-assigned">â†’ ${e.assignedTo.name} (${e.assignedTo.role})</span>`:''}
<button class="feed-expand" data-id="${e.id}" onclick="toggleDetails(this)">â–¶ Details</button>
</div>
<div class="feed-details" id="details-${e.id}">
${stepsHtml}
<div class="detail-raw">${JSON.stringify(e.raw,null,2)}</div>
<div class="feedback-section">
<h4>â­ Leave Feedback for Corey</h4>
${fbExistingHtml}
<div class="star-rating" id="stars-${e.id}">
${[1,2,3,4,5].map(n=>`<span class="star${fb&&fb.rating>=n?' active':''}" data-val="${n}" onclick="setStars('${e.id}',${n})">â˜…</span>`).join('')}
</div>
<textarea class="feedback-text" id="fb-text-${e.id}" placeholder="What do you think about this action? Any concerns?">${fb?fb.comment:''}</textarea>
<button class="feedback-save" onclick="saveFB('${e.id}')">ğŸ’¾ Save Feedback</button>
</div>
</div>
</div>`}).join('');
}

window.toggleDetails=function(btn){
const id=btn.dataset.id;
const det=document.getElementById('details-'+id);
det.classList.toggle('open');
btn.textContent=det.classList.contains('open')?'â–¼ Hide':'â–¶ Details';
};

window.setStars=function(id,val){
const container=document.getElementById('stars-'+id);
container.querySelectorAll('.star').forEach(s=>{
s.classList.toggle('active',parseInt(s.dataset.val)<=val);
});
container.dataset.selected=val;
};

window.saveFB=function(id){
const starsEl=document.getElementById('stars-'+id);
const rating=parseInt(starsEl.dataset.selected)||0;
const comment=document.getElementById('fb-text-'+id).value.trim();
if(!rating&&!comment){showToast('âš ï¸ Add a rating or comment first');return}
saveFeedback(id,rating||3,comment);
showToast('Saved âœ… Feedback recorded');
renderFeedbackSummary();
};

// â”€â”€ RENDER SCOREBOARD â”€â”€
function renderScoreboard(entries){
const stats={};
entries.forEach(e=>{
if(!stats[e.agent])stats[e.agent]={total:0,success:0,durations:[]};
stats[e.agent].total++;
if(e.result==='success')stats[e.agent].success++;
if(e.duration)stats[e.agent].durations.push(e.duration);
});
const sorted=Object.entries(stats).sort((a,b)=>b[1].total-a[1].total);
const maxTotal=sorted.length?sorted[0][1].total:1;
const el=document.getElementById('sbList');
el.innerHTML=sorted.map(([id,s])=>{
const a=AGENTS[id]||{emoji:'â“',name:id};
const rate=s.total?Math.round(s.success/s.total*100):0;
const avgD=s.durations.length?(s.durations.reduce((a,b)=>a+b,0)/s.durations.length).toFixed(1):'-';
const pct=Math.round(s.total/maxTotal*100);
const color=rate>=90?'var(--green)':rate>=70?'var(--yellow)':'var(--red)';
return `<div class="sb-agent">
<div class="sb-header"><span class="sb-name">${a.emoji} ${a.name}</span><span class="sb-count">${s.total} actions</span></div>
<div class="sb-bar-bg"><div class="sb-bar" style="width:${pct}%;background:${color}"></div></div>
<div class="sb-stats"><span>âœ… ${rate}%</span><span>â± ${avgD}s avg</span></div>
</div>`}).join('');
}

// â”€â”€ RENDER FEEDBACK SUMMARY â”€â”€
function renderFeedbackSummary(){
const allFb=getAllFeedback();
const el=document.getElementById('fsList');
if(!allFb.length){el.innerHTML='<div class="fs-empty">No feedback yet. Expand any entry above and leave a rating + comment.</div>';return}
// Match feedback to entries
el.innerHTML=allFb.sort((a,b)=>(b.ts||0)-(a.ts||0)).map(fb=>{
const entry=allEntries.find(e=>e.id===fb.id);
if(!entry) return '';
const a=AGENTS[entry.agent]||{emoji:'â“',name:entry.agent};
return `<div class="fs-entry">
<div class="fs-agent">${a.emoji} ${a.name} â€” ${ago(NOW-entry.timestamp)}</div>
<div class="fs-action">${entry.action}</div>
<div class="fs-stars">${'â˜…'.repeat(fb.rating)}${'â˜†'.repeat(5-fb.rating)} (${fb.rating}/5)</div>
${fb.comment?`<div class="fs-comment">"${fb.comment}"</div>`:''}
</div>`}).join('');
}

window.exportFeedback=function(){
const allFb=getAllFeedback();
if(!allFb.length){showToast('No feedback to export');return}
let text='GUNNER AUDIT FEEDBACK EXPORT\n'+new Date().toLocaleString()+'\n'+'='.repeat(50)+'\n\n';
allFb.forEach(fb=>{
const entry=allEntries.find(e=>e.id===fb.id);
if(!entry) return;
const a=AGENTS[entry.agent]||{emoji:'',name:entry.agent};
text+=`${a.emoji} ${a.name}\n`;
text+=`Action: ${entry.action}\n`;
text+=`Rating: ${'â˜…'.repeat(fb.rating)}${'â˜†'.repeat(5-fb.rating)} (${fb.rating}/5)\n`;
if(fb.comment) text+=`Comment: "${fb.comment}"\n`;
text+='\n---\n\n';
});
navigator.clipboard.writeText(text).then(()=>showToast('ğŸ“‹ Copied to clipboard!')).catch(()=>showToast('Failed to copy'));
};

// â”€â”€ RENDER ALL â”€â”€
function renderAll(){
const filtered=getFiltered();
renderErrors(filtered);
renderStats(filtered);
renderFeed(filtered);
renderScoreboard(filtered);
renderFeedbackSummary();
}

// Event listeners
document.getElementById('filterAgent').addEventListener('change',renderAll);
document.getElementById('filterResult').addEventListener('change',renderAll);
document.getElementById('filterSearch').addEventListener('input',renderAll);
document.querySelectorAll('.time-btn').forEach(btn=>{
btn.addEventListener('click',()=>{
document.querySelectorAll('.time-btn').forEach(b=>b.classList.remove('active'));
btn.classList.add('active');
selectedRange=parseInt(btn.dataset.range);
renderAll();
});
});

// Init
renderTriggerMap();
renderAll();
</script>
</body>
</html>
