<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gunner Control Room</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0f172a;--card:#1e293b;--border:#334155;--glow:rgba(59,130,246,.15);--blue:#3b82f6;--cyan:#06b6d4;--green:#22c55e;--yellow:#eab308;--orange:#f97316;--red:#ef4444;--purple:#a855f7;--pink:#ec4899;--text:#f1f5f9;--muted:#94a3b8;--dim:#64748b}
html{scroll-behavior:smooth}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);line-height:1.6;padding-bottom:80px}
a{color:var(--cyan);text-decoration:none}
a:hover{text-decoration:underline}

.header{text-align:center;padding:40px 20px 24px;position:relative}
.header::before{content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);width:600px;height:400px;background:radial-gradient(circle,rgba(59,130,246,.08),transparent 70%);pointer-events:none}
.header h1{font-size:clamp(1.6rem,4vw,2.4rem);font-weight:800;background:linear-gradient(135deg,#fff,var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:8px}
.header p{color:var(--muted);font-size:.95rem;margin-bottom:16px}
.header-links{display:flex;justify-content:center;gap:20px;font-size:.9rem}

.master{max-width:800px;margin:0 auto 32px;padding:0 16px}
.master-row{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-bottom:16px}
.master-btn{padding:12px 28px;border-radius:12px;font-weight:700;font-size:.95rem;border:none;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:8px}
.master-btn:active{transform:scale(.96)}
.btn-kill{background:rgba(239,68,68,.15);color:var(--red);border:2px solid rgba(239,68,68,.4)}
.btn-kill:hover{background:rgba(239,68,68,.25)}
.btn-enable{background:rgba(34,197,94,.15);color:var(--green);border:2px solid rgba(34,197,94,.4)}
.btn-enable:hover{background:rgba(34,197,94,.25)}
.dry-run-box{background:var(--card);border:2px solid rgba(234,179,8,.4);border-radius:16px;padding:20px 28px;display:flex;align-items:center;justify-content:center;gap:16px;flex-wrap:wrap}
.dry-run-box .label{font-size:1.1rem;font-weight:700;color:var(--yellow)}
.dry-run-box .hint{color:var(--muted);font-size:.8rem;width:100%;text-align:center}

.toggle{position:relative;width:52px;height:28px;flex-shrink:0}
.toggle input{opacity:0;width:0;height:0}
.toggle .slider{position:absolute;inset:0;background:#475569;border-radius:28px;cursor:pointer;transition:all .3s}
.toggle .slider::before{content:'';position:absolute;width:22px;height:22px;left:3px;top:3px;background:#fff;border-radius:50%;transition:all .3s}
.toggle input:checked+.slider{background:var(--green);box-shadow:0 0 12px rgba(34,197,94,.5)}
.toggle input:checked+.slider::before{transform:translateX(24px)}
.toggle-big{width:64px;height:34px}
.toggle-big .slider::before{width:28px;height:28px}
.toggle-big input:checked+.slider::before{transform:translateX(30px)}
.toggle-big input:checked+.slider{background:var(--yellow);box-shadow:0 0 12px rgba(234,179,8,.5)}

.container{max-width:1200px;margin:0 auto;padding:0 16px}
.phase-section{margin-bottom:32px}
.phase-title{font-size:1.15rem;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:10px}
.phase-title .dot{width:12px;height:12px;border-radius:50%;flex-shrink:0}

.agent-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
.agent-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;display:flex;align-items:flex-start;gap:12px;transition:all .3s;position:relative;overflow:hidden}
.agent-card.active{border-color:rgba(34,197,94,.3);box-shadow:0 0 20px rgba(34,197,94,.08)}
.agent-card.inactive{opacity:.5}
.agent-info{flex:1;min-width:0}
.agent-emoji{font-size:1.3rem;line-height:1}
.agent-name{font-weight:600;font-size:.9rem;margin-bottom:2px}
.agent-desc{color:var(--muted);font-size:.78rem;line-height:1.4}
.agent-right{display:flex;flex-direction:column;align-items:flex-end;gap:6px}

.bot-section{margin-top:40px;margin-bottom:32px}
.bot-section h2{font-size:1.4rem;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:10px}
.bot-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
.bot-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;display:flex;align-items:center;gap:12px;transition:all .3s}
.bot-card.active{border-color:rgba(34,197,94,.3);box-shadow:0 0 16px rgba(34,197,94,.06)}
.bot-card.inactive{opacity:.5}

.status-bar{position:fixed;bottom:0;left:0;right:0;background:rgba(15,23,42,.95);backdrop-filter:blur(12px);border-top:1px solid var(--border);padding:14px 20px;text-align:center;font-weight:600;font-size:.9rem;z-index:100;display:flex;justify-content:center;gap:24px}
.status-bar span{display:flex;align-items:center;gap:6px}

.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:200;align-items:center;justify-content:center;padding:20px}
.modal-overlay.show{display:flex}
.modal{background:var(--card);border:2px solid var(--red);border-radius:20px;padding:36px;text-align:center;max-width:400px;width:100%}
.modal h3{font-size:1.3rem;margin-bottom:12px;color:var(--red)}
.modal p{color:var(--muted);margin-bottom:24px;font-size:.95rem}
.modal-btns{display:flex;gap:12px;justify-content:center}
.modal-btns button{padding:10px 28px;border-radius:10px;font-weight:700;font-size:.9rem;border:none;cursor:pointer}
.modal-cancel{background:var(--border);color:var(--text)}
.modal-confirm{background:var(--red);color:#fff}

.toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--card);border:1px solid var(--border);padding:12px 24px;border-radius:12px;font-size:.9rem;font-weight:500;z-index:150;transition:transform .3s,opacity .3s;opacity:0;pointer-events:none;white-space:nowrap}
.toast.show{transform:translateX(-50%) translateY(0);opacity:1}
</style>
</head>
<body>

<div class="header">
  <h1>üî´ Gunner Control Room</h1>
  <p>Toggle agents and bots on/off. Changes take effect immediately.</p>
  <div class="header-links">
    <a href="/dashboard">‚Üê Dashboard</a>
    <a href="/dashboard/audit">üìã Audit Log</a>
    <a href="/dashboard/team">Team</a>
  </div>
</div>

<div class="master">
  <div class="master-row">
    <button class="master-btn btn-kill" onclick="killAll()">üî¥ KILL ALL</button>
    <button class="master-btn btn-enable" onclick="enableAll()">üü¢ ENABLE ALL</button>
  </div>
  <div class="dry-run-box">
    <span class="label">üü° DRY RUN</span>
    <label class="toggle toggle-big">
      <input type="checkbox" id="dryRunToggle" onchange="toggleDryRun(this.checked)">
      <span class="slider"></span>
    </label>
    <span class="hint">When ON, agents log actions but don't execute</span>
  </div>
</div>

<div class="container" id="agentContainer"></div>
<div class="container" id="botContainer"></div>

<div class="status-bar">
  <span>ü§ñ <span id="agentCount">0</span> agents active</span>
  <span>‚öôÔ∏è <span id="botCount">0</span> bots active</span>
</div>

<div class="modal-overlay" id="killModal">
  <div class="modal">
    <h3>üî¥ KILL ALL</h3>
    <p>This will disable ALL agents and bots. Are you sure?</p>
    <div class="modal-btns">
      <button class="modal-cancel" onclick="closeModal()">Cancel</button>
      <button class="modal-confirm" onclick="confirmKillAll()">Yes, Kill All</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// Agent grouping by toggle ID
const AGENT_GROUPS = [
  { name:'Phase 1 ‚Äî Intake', color:'#3b82f6', emoji:'üîç', ids:['new-lead-pipeline','lead-scorer','lead-tagger','lead-noter','lead-task-creator'] },
  { name:'Phase 2 ‚Äî Outreach', color:'#06b6d4', emoji:'üì±', ids:['initial-outreach','outbound-manager','working-drip'] },
  { name:'Phase 3 ‚Äî Conversations', color:'#22c55e', emoji:'üí¨', ids:['response-agent','lm-assistant','call-coaching','ghosted-agent','bucket-reeval','callback-capture','stage-change-router','already-sold-agent'] },
  { name:'Phase 4 ‚Äî Appointments', color:'#eab308', emoji:'üìÖ', ids:['apt-prep','apt-reminder-poller','am-assistant'] },
  { name:'Phase 5 ‚Äî Follow-Up', color:'#f97316', emoji:'üíå', ids:['follow-up-organizer','follow-up-messenger','follow-up-closer'] },
  { name:'Phase 6 ‚Äî Closing', color:'#a855f7', emoji:'üí∞', ids:['offer-chase','offer-reply','contract-bot','tc-packager','dispo-packager','uc-monitor','post-close-bot'] },
  { name:'Phase 7 ‚Äî Oversight', color:'#ef4444', emoji:'‚öñÔ∏è', ids:['accountability-agent','reality-check','reality-check-poller'] },
  { name:'Dispo Pipeline', color:'#ec4899', emoji:'üèòÔ∏è', ids:['deal-blaster','buyer-matcher','buyer-response','showing-manager','offer-collector','dispo-closer','jv-router','deal-terminator','dispo-accountability'] },
  { name:'Intelligence', color:'#06b6d4', emoji:'üß†', ids:['intelligence-poller','intelligence-researcher','intelligence-feedback'] },
];

const BOT_GROUPS = [
  { name:'Core Bots', emoji:'‚öôÔ∏è', ids:['bot-assign','bot-contact','bot-field','bot-note','bot-scorer','bot-sms','bot-stage','bot-tag','bot-task'] },
  { name:'Read Bots', emoji:'üìñ', ids:['bot-contact-search','bot-task-reader','bot-note-reader','bot-opportunity','bot-pipeline-reader'] },
  { name:'AI Bots', emoji:'ü§ñ', ids:['bot-ai-writer','bot-ai-classifier'] },
  { name:'Communication Bots', emoji:'üìß', ids:['bot-email'] },
  { name:'Logic Bots', emoji:'üß©', ids:['bot-classifier','bot-template','bot-scheduler','bot-guard','bot-compliance'] },
  { name:'Intelligence Bots', emoji:'üß†', ids:['bot-memory-writer','bot-memory-reader','bot-outcome-tracker','bot-learning-builder','bot-pattern-analyzer','bot-briefing-writer','bot-feedback-writer'] },
];

let allToggles = []; // from API

async function loadState() {
  try {
    const res = await fetch('/api/control/state');
    const data = await res.json();
    allToggles = data.toggles || [];
    document.getElementById('dryRunToggle').checked = data.dryRun || false;
  } catch (e) { console.warn('Failed to load state', e); }
}

function getToggle(id) { return allToggles.find(t => t.id === id); }
function isOn(id) { const t = getToggle(id); return t ? t.enabled : false; }

function apiToggle(id, enabled) {
  const t = getToggle(id);
  if (t) t.enabled = enabled;
  fetch('/api/control/toggle', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id,enabled}) }).catch(e => console.error('toggle error',e));
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(t._timer);
  t._timer = setTimeout(() => t.classList.remove('show'), 2200);
}

function updateCounts() {
  const agents = allToggles.filter(t => t.kind === 'agent');
  const bots = allToggles.filter(t => t.kind === 'bot');
  document.getElementById('agentCount').textContent = agents.filter(t => t.enabled).length + '/' + agents.length;
  document.getElementById('botCount').textContent = bots.filter(t => t.enabled).length + '/' + bots.length;
}

function refreshCard(id) {
  const card = document.querySelector(`[data-id="${id}"]`);
  if (card) { card.classList.toggle('active', isOn(id)); card.classList.toggle('inactive', !isOn(id)); }
}

function handleToggle(id, checked) {
  apiToggle(id, checked);
  refreshCard(id);
  updateCounts();
  const t = getToggle(id);
  showToast(`${t ? t.label : id} ${checked ? 'enabled' : 'disabled'} ‚úÖ`);
}

function killAll() { document.getElementById('killModal').classList.add('show'); }
function closeModal() { document.getElementById('killModal').classList.remove('show'); }
function confirmKillAll() {
  closeModal();
  allToggles.forEach(t => { apiToggle(t.id, false); refreshCard(t.id); const cb=document.getElementById('cb_'+t.id); if(cb) cb.checked=false; });
  updateCounts();
  showToast('All agents and bots disabled üî¥');
}
function enableAll() {
  allToggles.forEach(t => { apiToggle(t.id, true); refreshCard(t.id); const cb=document.getElementById('cb_'+t.id); if(cb) cb.checked=true; });
  updateCounts();
  showToast('All agents and bots enabled üü¢');
}
function toggleDryRun(val) {
  showToast(`DRY RUN ${val ? 'ON üü°' : 'OFF'} (env var change required)`);
}

function renderCard(t, type) {
  const on = t.enabled;
  if (type === 'bot') {
    return `<div class="bot-card ${on?'active':'inactive'}" data-id="${t.id}">
      <div class="agent-info">
        <div class="agent-name">${t.label}</div>
        <div class="agent-desc">${t.description}</div>
      </div>
      <label class="toggle"><input type="checkbox" id="cb_${t.id}" ${on?'checked':''} onchange="handleToggle('${t.id}',this.checked)"><span class="slider"></span></label>
    </div>`;
  }
  return `<div class="agent-card ${on?'active':'inactive'}" data-id="${t.id}">
    <div class="agent-info">
      <div class="agent-name">${t.label}</div>
      <div class="agent-desc">${t.description}</div>
    </div>
    <div class="agent-right">
      <label class="toggle"><input type="checkbox" id="cb_${t.id}" ${on?'checked':''} onchange="handleToggle('${t.id}',this.checked)"><span class="slider"></span></label>
    </div>
  </div>`;
}

function render() {
  // Build lookup of all toggles by id
  const byId = {};
  allToggles.forEach(t => byId[t.id] = t);
  const renderedAgentIds = new Set();
  const renderedBotIds = new Set();

  // Render agent groups
  const ac = document.getElementById('agentContainer');
  let agentHtml = '';
  AGENT_GROUPS.forEach(g => {
    const togglesInGroup = g.ids.map(id => byId[id]).filter(Boolean);
    if (!togglesInGroup.length) return;
    togglesInGroup.forEach(t => renderedAgentIds.add(t.id));
    agentHtml += `<div class="phase-section">
      <div class="phase-title"><span class="dot" style="background:${g.color}"></span>${g.emoji} ${g.name}</div>
      <div class="agent-grid">${togglesInGroup.map(t => renderCard(t,'agent')).join('')}</div>
    </div>`;
  });
  // Any ungrouped agents
  const ungroupedAgents = allToggles.filter(t => t.kind === 'agent' && !renderedAgentIds.has(t.id));
  if (ungroupedAgents.length) {
    agentHtml += `<div class="phase-section">
      <div class="phase-title"><span class="dot" style="background:var(--dim)"></span>üîß Other Agents</div>
      <div class="agent-grid">${ungroupedAgents.map(t => renderCard(t,'agent')).join('')}</div>
    </div>`;
  }
  ac.innerHTML = agentHtml;

  // Render bot groups
  const bc = document.getElementById('botContainer');
  let botHtml = '';
  BOT_GROUPS.forEach(g => {
    const togglesInGroup = g.ids.map(id => byId[id]).filter(Boolean);
    if (!togglesInGroup.length) return;
    togglesInGroup.forEach(t => renderedBotIds.add(t.id));
    botHtml += `<div class="bot-section">
      <h2>${g.emoji} ${g.name}</h2>
      <div class="bot-grid">${togglesInGroup.map(t => renderCard(t,'bot')).join('')}</div>
    </div>`;
  });
  // Any ungrouped bots
  const ungroupedBots = allToggles.filter(t => t.kind === 'bot' && !renderedBotIds.has(t.id));
  if (ungroupedBots.length) {
    botHtml += `<div class="bot-section">
      <h2>üîß Other Bots</h2>
      <div class="bot-grid">${ungroupedBots.map(t => renderCard(t,'bot')).join('')}</div>
    </div>`;
  }
  bc.innerHTML = botHtml;

  updateCounts();
}

loadState().then(() => render());
</script>
</body>
</html>
